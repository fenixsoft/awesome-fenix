<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>容器存储与生态 | 软件架构探索：The Fenix Project</title>
    <meta name="description" content="现代软件架构探索">
    <meta name="generator" content="VuePress 1.4.0">
    <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico">
    
    <link rel="preload" href="/assets/css/0.styles.acccec19.css" as="style"><link rel="preload" href="/assets/js/app.83b03387.js" as="script"><link rel="preload" href="/assets/js/3.9ff08370.js" as="script"><link rel="preload" href="/assets/js/6.f55cdd7e.js" as="script"><link rel="preload" href="/assets/js/12.b8693f70.js" as="script"><link rel="preload" href="/assets/js/46.b10d8f94.js" as="script"><link rel="prefetch" href="/assets/js/1.638c3a02.js"><link rel="prefetch" href="/assets/js/10.501b0a58.js"><link rel="prefetch" href="/assets/js/100.a53892c3.js"><link rel="prefetch" href="/assets/js/101.95c36aa1.js"><link rel="prefetch" href="/assets/js/102.341ba6e5.js"><link rel="prefetch" href="/assets/js/103.10ef06a9.js"><link rel="prefetch" href="/assets/js/104.61379bbd.js"><link rel="prefetch" href="/assets/js/105.85cb0e1f.js"><link rel="prefetch" href="/assets/js/106.962d0586.js"><link rel="prefetch" href="/assets/js/107.061cfc36.js"><link rel="prefetch" href="/assets/js/108.296ff28c.js"><link rel="prefetch" href="/assets/js/109.8f6fd584.js"><link rel="prefetch" href="/assets/js/11.804ebf20.js"><link rel="prefetch" href="/assets/js/110.00346ba7.js"><link rel="prefetch" href="/assets/js/111.ba3fa728.js"><link rel="prefetch" href="/assets/js/112.5b252029.js"><link rel="prefetch" href="/assets/js/113.2528e88d.js"><link rel="prefetch" href="/assets/js/114.66863b7d.js"><link rel="prefetch" href="/assets/js/115.03f40cc0.js"><link rel="prefetch" href="/assets/js/116.8e9071d5.js"><link rel="prefetch" href="/assets/js/117.bafa117c.js"><link rel="prefetch" href="/assets/js/118.6f50b2c5.js"><link rel="prefetch" href="/assets/js/119.a904b6d7.js"><link rel="prefetch" href="/assets/js/120.3c543dc5.js"><link rel="prefetch" href="/assets/js/121.ba8f79b9.js"><link rel="prefetch" href="/assets/js/122.40b1cd6d.js"><link rel="prefetch" href="/assets/js/123.d93aa6ff.js"><link rel="prefetch" href="/assets/js/124.c7fb3019.js"><link rel="prefetch" href="/assets/js/125.1f16240a.js"><link rel="prefetch" href="/assets/js/126.5ae65c5e.js"><link rel="prefetch" href="/assets/js/127.bf2a317a.js"><link rel="prefetch" href="/assets/js/128.440eb45f.js"><link rel="prefetch" href="/assets/js/129.4d66f9ad.js"><link rel="prefetch" href="/assets/js/13.d6fe6d88.js"><link rel="prefetch" href="/assets/js/130.74a85dc3.js"><link rel="prefetch" href="/assets/js/131.58b9bd5a.js"><link rel="prefetch" href="/assets/js/132.6ba9dab3.js"><link rel="prefetch" href="/assets/js/133.adb809be.js"><link rel="prefetch" href="/assets/js/134.997c1fa3.js"><link rel="prefetch" href="/assets/js/135.e3a1e08c.js"><link rel="prefetch" href="/assets/js/136.1b5e76d2.js"><link rel="prefetch" href="/assets/js/137.cb9ea8a4.js"><link rel="prefetch" href="/assets/js/138.968f98a4.js"><link rel="prefetch" href="/assets/js/139.923081b0.js"><link rel="prefetch" href="/assets/js/14.ee6d0ad6.js"><link rel="prefetch" href="/assets/js/140.4db11388.js"><link rel="prefetch" href="/assets/js/141.ea305a6a.js"><link rel="prefetch" href="/assets/js/142.e674b09c.js"><link rel="prefetch" href="/assets/js/143.9f12ab97.js"><link rel="prefetch" href="/assets/js/144.398af00b.js"><link rel="prefetch" href="/assets/js/145.986b0b4d.js"><link rel="prefetch" href="/assets/js/146.6193ba5f.js"><link rel="prefetch" href="/assets/js/147.39880a4a.js"><link rel="prefetch" href="/assets/js/148.05c26b95.js"><link rel="prefetch" href="/assets/js/149.ccb35ee1.js"><link rel="prefetch" href="/assets/js/15.0d0dd13b.js"><link rel="prefetch" href="/assets/js/150.0f7b8b74.js"><link rel="prefetch" href="/assets/js/151.5e65be92.js"><link rel="prefetch" href="/assets/js/152.97b653fb.js"><link rel="prefetch" href="/assets/js/153.6c445772.js"><link rel="prefetch" href="/assets/js/154.32cf0494.js"><link rel="prefetch" href="/assets/js/155.be2ec0da.js"><link rel="prefetch" href="/assets/js/156.65ec0b57.js"><link rel="prefetch" href="/assets/js/157.0924cd02.js"><link rel="prefetch" href="/assets/js/158.5d9ab7b1.js"><link rel="prefetch" href="/assets/js/159.ae5efbc0.js"><link rel="prefetch" href="/assets/js/16.05c314b9.js"><link rel="prefetch" href="/assets/js/160.72cfaea6.js"><link rel="prefetch" href="/assets/js/161.45869c04.js"><link rel="prefetch" href="/assets/js/162.a8cb33b6.js"><link rel="prefetch" href="/assets/js/163.8b910fd8.js"><link rel="prefetch" href="/assets/js/164.1900a9f7.js"><link rel="prefetch" href="/assets/js/165.416f88af.js"><link rel="prefetch" href="/assets/js/166.b3bef370.js"><link rel="prefetch" href="/assets/js/167.15245e8d.js"><link rel="prefetch" href="/assets/js/17.b4f0121e.js"><link rel="prefetch" href="/assets/js/18.ef40354a.js"><link rel="prefetch" href="/assets/js/19.fe812442.js"><link rel="prefetch" href="/assets/js/20.bebf15e9.js"><link rel="prefetch" href="/assets/js/21.99799ade.js"><link rel="prefetch" href="/assets/js/22.c1e50555.js"><link rel="prefetch" href="/assets/js/23.1d394c54.js"><link rel="prefetch" href="/assets/js/24.26397b00.js"><link rel="prefetch" href="/assets/js/25.dd3479fc.js"><link rel="prefetch" href="/assets/js/26.cf190ba2.js"><link rel="prefetch" href="/assets/js/27.58a21ebf.js"><link rel="prefetch" href="/assets/js/28.09af0254.js"><link rel="prefetch" href="/assets/js/29.3a1b92c8.js"><link rel="prefetch" href="/assets/js/30.9a6f6f33.js"><link rel="prefetch" href="/assets/js/31.a7e4f2aa.js"><link rel="prefetch" href="/assets/js/32.ec40bd1c.js"><link rel="prefetch" href="/assets/js/33.0fe9e3ab.js"><link rel="prefetch" href="/assets/js/34.feab5d6b.js"><link rel="prefetch" href="/assets/js/35.768bf19c.js"><link rel="prefetch" href="/assets/js/36.fc928e28.js"><link rel="prefetch" href="/assets/js/37.7f192220.js"><link rel="prefetch" href="/assets/js/38.5717e081.js"><link rel="prefetch" href="/assets/js/39.c226f545.js"><link rel="prefetch" href="/assets/js/4.30544bf9.js"><link rel="prefetch" href="/assets/js/40.46911532.js"><link rel="prefetch" href="/assets/js/41.343ee5a8.js"><link rel="prefetch" href="/assets/js/42.9787769e.js"><link rel="prefetch" href="/assets/js/43.7bcd7d8c.js"><link rel="prefetch" href="/assets/js/44.07d10170.js"><link rel="prefetch" href="/assets/js/45.fa076636.js"><link rel="prefetch" href="/assets/js/47.c5012766.js"><link rel="prefetch" href="/assets/js/48.986358e4.js"><link rel="prefetch" href="/assets/js/49.ff70bd50.js"><link rel="prefetch" href="/assets/js/5.a9ba82a9.js"><link rel="prefetch" href="/assets/js/50.ceb08b5a.js"><link rel="prefetch" href="/assets/js/51.19d63c41.js"><link rel="prefetch" href="/assets/js/52.5ba0577f.js"><link rel="prefetch" href="/assets/js/53.d2064d5d.js"><link rel="prefetch" href="/assets/js/54.3fac1512.js"><link rel="prefetch" href="/assets/js/55.f090a191.js"><link rel="prefetch" href="/assets/js/56.bdf59f97.js"><link rel="prefetch" href="/assets/js/57.79282424.js"><link rel="prefetch" href="/assets/js/58.c9ee04b9.js"><link rel="prefetch" href="/assets/js/59.300ecd7b.js"><link rel="prefetch" href="/assets/js/60.14192fdc.js"><link rel="prefetch" href="/assets/js/61.b5dc1832.js"><link rel="prefetch" href="/assets/js/62.1598f9d8.js"><link rel="prefetch" href="/assets/js/63.762ba2be.js"><link rel="prefetch" href="/assets/js/64.f8a67f69.js"><link rel="prefetch" href="/assets/js/65.eacb0537.js"><link rel="prefetch" href="/assets/js/66.79a4bf9c.js"><link rel="prefetch" href="/assets/js/67.2ab5830d.js"><link rel="prefetch" href="/assets/js/68.b883a35d.js"><link rel="prefetch" href="/assets/js/69.513dbef4.js"><link rel="prefetch" href="/assets/js/7.0a8d7beb.js"><link rel="prefetch" href="/assets/js/70.050c05db.js"><link rel="prefetch" href="/assets/js/71.ef72975c.js"><link rel="prefetch" href="/assets/js/72.ad32adcd.js"><link rel="prefetch" href="/assets/js/73.a7ce7dbe.js"><link rel="prefetch" href="/assets/js/74.32b4e022.js"><link rel="prefetch" href="/assets/js/75.8c112bae.js"><link rel="prefetch" href="/assets/js/76.2d0636bc.js"><link rel="prefetch" href="/assets/js/77.168611ca.js"><link rel="prefetch" href="/assets/js/78.8665d836.js"><link rel="prefetch" href="/assets/js/79.d3523b81.js"><link rel="prefetch" href="/assets/js/8.844880cb.js"><link rel="prefetch" href="/assets/js/80.b0de88a3.js"><link rel="prefetch" href="/assets/js/81.7feb4ed8.js"><link rel="prefetch" href="/assets/js/82.fbd10f4f.js"><link rel="prefetch" href="/assets/js/83.7fcd79f8.js"><link rel="prefetch" href="/assets/js/84.1a2d4269.js"><link rel="prefetch" href="/assets/js/85.90236bcc.js"><link rel="prefetch" href="/assets/js/86.80dac2c6.js"><link rel="prefetch" href="/assets/js/87.4ffbe0db.js"><link rel="prefetch" href="/assets/js/88.4c302e03.js"><link rel="prefetch" href="/assets/js/89.a35e9872.js"><link rel="prefetch" href="/assets/js/9.973a31b9.js"><link rel="prefetch" href="/assets/js/90.05f244c6.js"><link rel="prefetch" href="/assets/js/91.22e758a8.js"><link rel="prefetch" href="/assets/js/92.f9d0eabc.js"><link rel="prefetch" href="/assets/js/93.6d940886.js"><link rel="prefetch" href="/assets/js/94.0fd27047.js"><link rel="prefetch" href="/assets/js/95.6c2b9a47.js"><link rel="prefetch" href="/assets/js/96.8e9ee86f.js"><link rel="prefetch" href="/assets/js/97.07612a21.js"><link rel="prefetch" href="/assets/js/98.48d7d497.js"><link rel="prefetch" href="/assets/js/99.a8a9eaaa.js">
    <link rel="stylesheet" href="/assets/css/0.styles.acccec19.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/images/logo-color.png" alt="软件架构探索：The Fenix Project" class="logo"> <span class="site-name can-hide">软件架构探索：The Fenix Project</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="代码" class="dropdown-title"><span class="title">代码</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/fenixsoft/awesome-fenix" target="_blank" rel="noopener noreferrer" class="nav-link external">
  文档工程 Awesome-Fenix
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://github.com/fenixsoft/fenix-bookstore-frontend" target="_blank" rel="noopener noreferrer" class="nav-link external">
  前端工程 Fenix's Bookstore
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://bookstore.icyfenix.cn" target="_blank" rel="noopener noreferrer" class="nav-link external">
  前端工程在线示例 Fenix's Bookstore
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://github.com/fenixsoft/monolithic_arch_springboot" target="_blank" rel="noopener noreferrer" class="nav-link external">
  后端：单体架构 Spring Boot
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://github.com/fenixsoft/microservice_arch_springcloud" target="_blank" rel="noopener noreferrer" class="nav-link external">
  后端：微服务架构 Spring Cloud
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://github.com/fenixsoft/microservice_arch_kubernetes" target="_blank" rel="noopener noreferrer" class="nav-link external">
  后端：微服务架构 Kubernetes
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://github.com/fenixsoft/servicemesh_arch_istio" target="_blank" rel="noopener noreferrer" class="nav-link external">
  后端：微服务架构 Istio
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://github.com/fenixsoft/serverless_arch_awslambda" target="_blank" rel="noopener noreferrer" class="nav-link external">
  后端：无服务架构 AWS Lambda
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div><div class="nav-item"><a href="https://raw.githubusercontent.com/fenixsoft/awesome-fenix/gh-pages/pdf/the-fenix-project.pdf" target="_blank" rel="noopener noreferrer" class="nav-link external">
  PDF下载
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="/board/" class="nav-link">
  讨论区
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="代码" class="dropdown-title"><span class="title">代码</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/fenixsoft/awesome-fenix" target="_blank" rel="noopener noreferrer" class="nav-link external">
  文档工程 Awesome-Fenix
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://github.com/fenixsoft/fenix-bookstore-frontend" target="_blank" rel="noopener noreferrer" class="nav-link external">
  前端工程 Fenix's Bookstore
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://bookstore.icyfenix.cn" target="_blank" rel="noopener noreferrer" class="nav-link external">
  前端工程在线示例 Fenix's Bookstore
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://github.com/fenixsoft/monolithic_arch_springboot" target="_blank" rel="noopener noreferrer" class="nav-link external">
  后端：单体架构 Spring Boot
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://github.com/fenixsoft/microservice_arch_springcloud" target="_blank" rel="noopener noreferrer" class="nav-link external">
  后端：微服务架构 Spring Cloud
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://github.com/fenixsoft/microservice_arch_kubernetes" target="_blank" rel="noopener noreferrer" class="nav-link external">
  后端：微服务架构 Kubernetes
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://github.com/fenixsoft/servicemesh_arch_istio" target="_blank" rel="noopener noreferrer" class="nav-link external">
  后端：微服务架构 Istio
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://github.com/fenixsoft/serverless_arch_awslambda" target="_blank" rel="noopener noreferrer" class="nav-link external">
  后端：无服务架构 AWS Lambda
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div><div class="nav-item"><a href="https://raw.githubusercontent.com/fenixsoft/awesome-fenix/gh-pages/pdf/the-fenix-project.pdf" target="_blank" rel="noopener noreferrer" class="nav-link external">
  PDF下载
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="/board/" class="nav-link">
  讨论区
</a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/summary/" class="sidebar-link">目录</a></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>前言</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/introduction/about-me.html" class="sidebar-link">关于作者</a></li><li><a href="/introduction/about-the-fenix-project.html" class="sidebar-link">什么是“The Fenix Project”</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>探索起步</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading open"><span>阅读指引</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/changelog/" class="sidebar-link">更新日志</a></li><li><a href="/exploration/guide/quick-start.html" class="sidebar-link">如何开始</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><a href="/exploration/projects/" class="sidebar-heading clickable"><span>技术演示工程</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/exploration/projects/fenix-bookstore-frontend.html" class="sidebar-link">前端工程</a></li><li><a href="/exploration/projects/monolithic_arch_springboot.html" class="sidebar-link">单体架构：Spring Boot</a></li><li><a href="/exploration/projects/microservice_arch_springcloud.html" class="sidebar-link">微服务：Spring Cloud</a></li><li><a href="/exploration/projects/microservice_arch_kubernetes.html" class="sidebar-link">微服务：Kubernetes</a></li><li><a href="/exploration/projects/servicemesh_arch_istio.html" class="sidebar-link">服务网格：Istio</a></li><li><a href="/exploration/projects/serverless_arch.html" class="sidebar-link">无服务：AWS Lambda</a></li></ul></section></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>演进中的架构</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group is-sub-group depth-1"><a href="/architecture/architect-history/" class="sidebar-heading clickable open"><span>服务架构演进史</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/architecture/architect-history/primitive-distribution.html" class="sidebar-link">原始分布式时代</a></li><li><a href="/architecture/architect-history/monolithic.html" class="sidebar-link">单体系统时代</a></li><li><a href="/architecture/architect-history/soa.html" class="sidebar-link">SOA时代</a></li><li><a href="/architecture/architect-history/microservices.html" class="sidebar-link">微服务时代</a></li><li><a href="/architecture/architect-history/post-microservices.html" class="sidebar-link">后微服务时代</a></li><li><a href="/architecture/architect-history/serverless.html" class="sidebar-link">无服务时代</a></li></ul></section></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>架构师的视角</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group is-sub-group depth-1"><a href="/architect-perspective/general-architecture/api-style/" class="sidebar-heading clickable open"><span>访问远程服务</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/architect-perspective/general-architecture/api-style/rpc.html" class="sidebar-link">远程服务调用</a></li><li><a href="/architect-perspective/general-architecture/api-style/rest.html" class="sidebar-link">REST设计风格</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><a href="/architect-perspective/general-architecture/transaction/" class="sidebar-heading clickable"><span>事务处理</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/architect-perspective/general-architecture/transaction/local.html" class="sidebar-link">本地事务</a></li><li><a href="/architect-perspective/general-architecture/transaction/global.html" class="sidebar-link">全局事务</a></li><li><a href="/architect-perspective/general-architecture/transaction/share.html" class="sidebar-link">共享事务</a></li><li><a href="/architect-perspective/general-architecture/transaction/distributed.html" class="sidebar-link">分布式事务</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><a href="/architect-perspective/general-architecture/diversion-system/" class="sidebar-heading clickable"><span>透明多级分流系统</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/architect-perspective/general-architecture/diversion-system/client-cache.html" class="sidebar-link">客户端缓存</a></li><li><a href="/architect-perspective/general-architecture/diversion-system/dns-lookup.html" class="sidebar-link">域名解析</a></li><li><a href="/architect-perspective/general-architecture/diversion-system/transmission-optimization.html" class="sidebar-link">传输链路</a></li><li><a href="/architect-perspective/general-architecture/diversion-system/cdn.html" class="sidebar-link">内容分发网络</a></li><li><a href="/architect-perspective/general-architecture/diversion-system/load-balancing.html" class="sidebar-link">负载均衡</a></li><li><a href="/architect-perspective/general-architecture/diversion-system/cache-middleware.html" class="sidebar-link">服务端缓存</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><a href="/architect-perspective/general-architecture/system-security/" class="sidebar-heading clickable"><span>架构安全性</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/architect-perspective/general-architecture/system-security/authentication.html" class="sidebar-link">认证</a></li><li><a href="/architect-perspective/general-architecture/system-security/authorization.html" class="sidebar-link">授权</a></li><li><a href="/architect-perspective/general-architecture/system-security/credentials.html" class="sidebar-link">凭证</a></li><li><a href="/architect-perspective/general-architecture/system-security/confidentiality.html" class="sidebar-link">保密</a></li><li><a href="/architect-perspective/general-architecture/system-security/transport-security.html" class="sidebar-link">传输</a></li><li><a href="/architect-perspective/general-architecture/system-security/verification.html" class="sidebar-link">验证</a></li></ul></section></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>分布式的基石</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group is-sub-group depth-1"><a href="/distribution/consensus/" class="sidebar-heading clickable open"><span>分布式共识算法</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/distribution/consensus/paxos.html" class="sidebar-link">Paxos</a></li><li><a href="/distribution/consensus/raft.html" class="sidebar-link">Multi Paxos</a></li><li><a href="/distribution/consensus/gossip.html" class="sidebar-link">Gossip协议</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><a href="/distribution/connect/" class="sidebar-heading clickable"><span>从类库到服务</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/distribution/connect/service-discovery.html" class="sidebar-link">服务发现</a></li><li><a href="/distribution/connect/service-routing.html" class="sidebar-link">网关路由</a></li><li><a href="/distribution/connect/load-balancing.html" class="sidebar-link">客户端负载均衡</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><a href="/distribution/traffic-management/" class="sidebar-heading clickable"><span>流量治理</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/distribution/traffic-management/failure.html" class="sidebar-link">服务容错</a></li><li><a href="/distribution/traffic-management/traffic-control.html" class="sidebar-link">流量控制</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><a href="/distribution/secure/" class="sidebar-heading clickable"><span>可靠通讯</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/distribution/secure/zero-trust.html" class="sidebar-link">零信任网络</a></li><li><a href="/distribution/secure/service-security.html" class="sidebar-link">服务安全</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><a href="/distribution/observability/" class="sidebar-heading clickable"><span>可观测性</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/distribution/observability/logging.html" class="sidebar-link">事件日志</a></li><li><a href="/distribution/observability/tracing.html" class="sidebar-link">链路追踪</a></li><li><a href="/distribution/observability/metrics.html" class="sidebar-link">聚合度量</a></li></ul></section></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>不可变基础设施</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/immutable-infrastructure/msa-to-cn.html" class="sidebar-link">从微服务到云原生</a></li><li><section class="sidebar-group is-sub-group depth-1"><a href="/immutable-infrastructure/container/" class="sidebar-heading clickable"><span>虚拟化容器</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/immutable-infrastructure/container/history.html" class="sidebar-link">容器的崛起</a></li><li><a href="/immutable-infrastructure/container/container-build-system.html" class="sidebar-link">以容器构建系统</a></li><li><a href="/immutable-infrastructure/container/application-centric.html" class="sidebar-link">以应用为中心的封装</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><a href="/immutable-infrastructure/network/" class="sidebar-heading clickable"><span>容器间网络</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/immutable-infrastructure/network/linux-vnet.html" class="sidebar-link">Linux网络虚拟化</a></li><li><a href="/immutable-infrastructure/network/cni.html" class="sidebar-link">容器网络与生态</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><a href="/immutable-infrastructure/storage/" class="sidebar-heading clickable router-link-active open"><span>持久化存储</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/immutable-infrastructure/storage/storage-evolution.html" class="sidebar-link">Kubernetes存储设计</a></li><li><a href="/immutable-infrastructure/storage/csi.html" class="active sidebar-link">容器存储与生态</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/immutable-infrastructure/storage/csi.html#kubernetes存储架构" class="sidebar-link">Kubernetes存储架构</a></li><li class="sidebar-sub-header"><a href="/immutable-infrastructure/storage/csi.html#flexvolume与csi" class="sidebar-link">FlexVolume与CSI</a></li><li class="sidebar-sub-header"><a href="/immutable-infrastructure/storage/csi.html#从in-tree到out-of-tree" class="sidebar-link">从In-Tree到Out-of-Tree</a></li><li class="sidebar-sub-header"><a href="/immutable-infrastructure/storage/csi.html#容器插件生态" class="sidebar-link">容器插件生态</a></li></ul></li></ul></section></li><li><a href="/immutable-infrastructure/schedule/hardware-schedule.html" class="sidebar-link">资源与调度</a></li><li><section class="sidebar-group is-sub-group depth-1"><a href="/immutable-infrastructure/mesh/" class="sidebar-heading clickable"><span>服务网格</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/immutable-infrastructure/mesh/communication.html" class="sidebar-link">透明通信的涅槃</a></li><li><a href="/immutable-infrastructure/mesh/ecosystems.html" class="sidebar-link">服务网格与生态</a></li></ul></section></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>技术方法论</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group is-sub-group depth-1"><a href="/methodology/forward-msa/" class="sidebar-heading clickable open"><span>向微服务迈进</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/methodology/forward-msa/objective.html" class="sidebar-link">目的：微服务的驱动力</a></li><li><a href="/methodology/forward-msa/prerequest.html" class="sidebar-link">前提：微服务需要的条件</a></li><li><a href="/methodology/forward-msa/granularity.html" class="sidebar-link">边界：微服务的粒度</a></li><li><a href="/methodology/forward-msa/governance.html" class="sidebar-link">治理：理解系统复杂性</a></li></ul></section></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>随笔文章</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading open"><span>2020年</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group is-sub-group depth-2"><a href="/tricks/2020/graalvm/" class="sidebar-heading clickable open"><span>Graal VM</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/tricks/2020/graalvm/graal-compiler.html" class="sidebar-link">新一代即时编译器</a></li><li><a href="/tricks/2020/graalvm/substratevm.html" class="sidebar-link">向原生迈进</a></li><li><a href="/tricks/2020/graalvm/graalvm-native.html" class="sidebar-link">没有虚拟机的Java</a></li><li><a href="/tricks/2020/graalvm/spring-over-graal.html" class="sidebar-link">Spring over Graal</a></li></ul></section></li><li><a href="/tricks/2020/java-crisis/qcon.html" class="sidebar-link">QCon2020主题演讲：云原生时代，Java的危与机</a></li></ul></section></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>附录</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group is-sub-group depth-1"><a href="/appendix/deployment-env-setup/" class="sidebar-heading clickable open"><span>部署环境</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/appendix/deployment-env-setup/setup-docker.html" class="sidebar-link">部署Docker CE容器环境</a></li><li><section class="sidebar-group collapsable is-sub-group depth-2"><a href="/appendix/deployment-env-setup/setup-kubernetes/" class="sidebar-heading clickable"><span>部署Kubernetes集群</span> <span class="arrow right"></span></a> <!----></section></li></ul></section></li><li><a href="/appendix/istio.html" class="sidebar-link">部署Istio</a></li><li><a href="/appendix/operation-env-setup/elk-setup.html" class="sidebar-link">部署Elastic Stack</a></li><li><a href="/appendix/operation-env-setup/prometheus-setup.html" class="sidebar-link">部署Prometheus</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="容器存储与生态">容器存储与生态</h1> <p>容器存储具有很强的多样性，如何对接后端实际的存储系统，并且完全发挥出它所有的性能与功能并不是Kubernetes团队所擅长的工作，这件事情只有存储提供商自己才能做到最好。由此可以理解容器编排系统为何会有很强烈的意愿想把存储功能独立到外部去实现，在前面的讲解中，笔者已经反复提到过多次In-Tree、Out-of-Tree插件，这节，我们会以存储插件的接口与实现为中心，去解析Kubernetes的容器存储生态。</p> <h2 id="kubernetes存储架构">Kubernetes存储架构</h2> <p>正式开始讲解Kubernetes的In-Tree、Out-of-Tree存储插件前，我们有必要先去了解一点Kubernetes存储架构的知识，大体上弄清一个真实的存储系统是如何接入到新创建的Pod中，成为可以读写访问的Volume的；以及当Pod被销毁时，Volume如何被回收，回归到存储系统之中的。Kubernetes参考了传统操作系统接入或移除新存储设备做法，把接入或移除外部存储这件事情分解为以下三种操作：</p> <ul><li>首先，决定应<strong>准备</strong>（Provision）何种存储，Provision可类比为给操作系统扩容而购买了新的存储设备。这步确定了接入存储的来源、容量、性能以及其他技术参数，它的逆操作是<strong>移除</strong>（Delete）存储。</li> <li>然后，将准备好的存储<strong>附加</strong>（Attach）到系统中，Attach可类比为将存储设备接入操作系统，此时尽管设备还不能使用，但你已经可以用操作系统的<code>fdisk -l</code>命令查看到设备。这步确定了存储的设备名称、驱动方式等面向系统一侧的信息，它的逆操作是<strong>分离</strong>（Detach）存储设备。</li> <li>最后，将附加好的存储<strong>挂载</strong>（Mount）到系统中，Mount可类比为将设备挂载到系统的指定位置，也就是操作系统中<code>mount</code>命令的作用。这步确定了存储的访问目录、文件系统格式等面向应用一侧的信息，它的逆操作是<strong>卸载</strong>（Unmount）存储设备。</li></ul> <p>以上提到的Provision、Delete、Attach、Detach、Mount、Unmount六种操作，并不是直接由Kubernetes来实现，实际行为均是在存储插件中完成的，它们会分别被Kubernetes通过两个控制器及一个管理器来进行调用，这些控制器、管理器的作用分别是：</p> <ul><li><strong>PV控制器</strong>（PersistentVolume Controller）：“<a href="/immutable-infrastructure/container/container-build-system.html#韧性与弹性">以容器构建系统</a>”一节中介绍过，Kubernetes里所有的控制器都遵循着相同的工作模式——让实际状态尽可能接近期望状态。PV控制器的期望状态有两个，分别是“所有未绑定的PersistentVolume都能处于可用状态”以及“所有处于等待状态的PersistentVolumeClaim都能配对到与之绑定的PersistentVolume”，它内部也有两个相对独立的核心逻辑（ClaimWorker和VolumeWorker）来分别跟踪这两种期望状态，可以简单地理解为PV控制器实现了PersistentVolume和PersistentVolumeClaim的生命周期管理职能，在这个过程中，会根据需要调用存储驱动插件的Provision/Delete操作。</li> <li><strong>AD控制器</strong>（Attach/Detach Controller）：AD控制器的期望状态是“所有被调度到准备新创建Pod的节点，都附加好了要使用的存储；当Pod被销毁后，原本运行Pod的节点都分离了不再被使用的存储”，如果实际状态不符合该期望，会根据需要调用存储驱动插件的Attach/Detach操作。</li> <li><strong>Volume管理器</strong>（Volume Manager）：Volume管理器实际上是kubelet的一部分，是kubelet中众多管理器的其中一个，它主要是用来支持本节点中Volume执行Attach/Detach/Mount/Unmount操作。你可能注意到这里不仅有Mount/Unmount操作，也出现了Attach/Detach操作，这是历史原因导致的，由于最初版本的Kubernetes中并没有AD控制器，Attach/Detach的职责也在kubelet中完成。现在kubelet默认情况下已经不再会执行Attach/Detach了，但有少量旧程序已经依赖了由kubelet来实现Attach/Detach的内部逻辑，所以kubelet不得不设计一个<code>--enable-controller-attach-detach</code>参数，如果将其设置为<code>false</code>的话就会重新回到旧的兼容模式上，由kubelet代替AD控制器来完成Attach/Detach。</li></ul> <div class="custom-block center"><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAfYAAAEwCAMAAAByhKMnAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyFpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuNS1jMDE0IDc5LjE1MTQ4MSwgMjAxMy8wMy8xMy0xMjowOToxNSAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENDIChXaW5kb3dzKSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDpGOTIwRTU4NzA2RTIxMUVCQkMyQURCNDQxRDhGQjkzMiIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDpGOTIwRTU4ODA2RTIxMUVCQkMyQURCNDQxRDhGQjkzMiI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkY5MjBFNTg1MDZFMjExRUJCQzJBREI0NDFEOEZCOTMyIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOkY5MjBFNTg2MDZFMjExRUJCQzJBREI0NDFEOEZCOTMyIi8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+7LwWxgAAAYBQTFRFOTk5iYmJRERELkJVNjY2zMzM7+/venp69/f33t7eXl5esLCwkpKStbi609bZnp+hb3ByhIWH2t3gxcfKwdnxbW1tQEBAWFhZS0tLl6GqiJOeprjMxt73cXFxaHF6wNfvkaCwyMjIU1heZGVmXV1dhoaG19fXoKCgmZmZWFhYuLi4eoaSs8jeR0hISEhIV1dYxMTEp6enZWVlRUhLV1dX09PTsrKynZ2dUlddj4+Pu7u76OjoXmVtm5ubk5OT+fn5bGxs9PT08fHxmJiYp6mrjY+Qb29v39/fQ0NDMDpDT09PdHR07OzsvLy85+fnkJCQaWlpYWFhr7Gzo6OjU1NThYWFWVlZZGRktLS0maq7MTEx7u7uq6urWlpaPz8/t7e3cnJyZGRlxsbG0NDQ+/v7goKC2NjYqqqqhISEqKioUFBQUVFRzc3NlpiZent8go+dipinjo6Od3d3lZWVoLLE3d3dzc/SZ2dnLkFUqampMjIy4eTn5eXlzOX/////////96+KNQAAAIB0Uk5T/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////wA4BUtnAAATuUlEQVR42uydi2PbthHGs26URJE0LXuutdmJX5E924nrpHOyJG3SrO3a9d1t3dq9u7Xr3u8nnFj/+nB3AAlakm3FoC2K322pLBIkD/fD3eEAWb7Sh9RQrsAEwA4BdgiwQ4AdAuwQYIcAOwTYIcAOAXbIpWL/8uXLGIp/7fK1/doY6k6YcYEd2A8vV8bE/vXL1fbrY2KfKOMCO7ADO7ADO7ADO7ADO7ADO7ADO7ADO7ADO7ADO7ADO7ADO7ADO7ADO7ADe/nY52aVUjfnDzsdeZfmh/XR02VmY/4w7Vwc9rnZ2Tn9kmit1eJMdpjen0UL0pVULg27seDMYuJa6BRJjO4zi9y5C8Gu1UwXZxK24fwLouL8TX10pjOgg9ObS8I+/ymryOomygzSww69TZPB1i/MXzD2w1SGZT4kz4RdXCz59EKxa5oCVHTW79MRvn3p2NOU41JxlKaO3182dnlkp3M4DvZFjhFzf/7TRWNnRW2Mz8dqqoOnPpbMfo+C6PxNiqzJ7J/0MRNWLfaEk8Lc7GuLIxD4wa4fJ44uTzmWmrLclHZSZXScnWGd8jPCIeUcMbPx2s2hln527JlBXQuRnnRMj1mlEn2CHppmaSpZTDZm2Mp0vMOnjcmzZtr2N1/TragjnUO+U3JO7B16jL535j12rJIbkesnzDyx3aGBwJA7Fju9Tci4o/zOE/Zkdm5uNsmwi6KZP5FCrEpKzPUrdYh1ys8YlfUxHdpGJtNzTOlSY0zXQhl2Rf86bFOjgmD/N2NIE7o2KZh8/jW5iz5EPaGfiVmqknNP6ejhZE2L275KTNe6sJU7qcHOZiQHm9+YEewyxDfmc78rCXsnze06iF2O6jbUhDok2FP3DHPgfpD2i4n3mTxjTosWyrBrvdi3OqlVweitjazfJGYU6uutyU03+Uxi5mD6fVoYr8/m7ebe7EfGp5y0JEo52I1NOY9Z7DSzVkl2h5KwzywqKTxskE+lDwW9tY3TzqGDPSmeYexyn5F59zwFnEa6MV+0UB7kTfLvdLKuiIX1WQOXixTDWfePEqv2Sx7gNDDY0Oa9D+zzG8nGTHHmlnv7IPZBb3cBlIQ9lbiUHp/SmWHq+vQx7EO8/aTp1nmwS4oe7u0u9sSZ0lG81+0SyjsJj09jcqm0NGbX2908fF7sc7OfZrfizKELOMntyeEAdpO5UpvbuWFnrmTsRllbbyY2v0mKThPJ4GTD49jdM8yBou3r5WCf2XiB1CxYiJ6sCtitChb7/E2exzH2+ZsF7NQ9mVlRVEi5VPWGvTBLkDm7zOQtac6rykR8jkVpPpOX+WbJ2I13axMcX67piDaUbEzyE106NJNPDgtnmLVMl0vBftgxoTu3ED399aK3WxWyKNUxdqZ5/p8LQX7xdTnM831KDum5vR2LsxVanE1GlfXAPqXYacl05CoasE+tt5uUAezYgQN2YAd2YAd2YAd2YAd2YAd2YAd2YAd2YAd2YAf2KmA/r/wXX0c4Gvu0fgvld9V3q4RdqSph92xcj181/LZ6u18hUapK2no2rkfsP1A/qJAdD5Q6qJC6no3rD/sDpdSD6tjxoVIPq6Otb+P6w35Ha3anOoZ8S6m3qqOtb+P6w/4drdl3KmPHNfqA5Vpl1PVtXG/YQ/5QflgVO94jbe9VRVvvxvWG/RZrdqsidnzcJW27jyuirnfjesP+Cmv2SkXs+C5rq96tiLrejesL+4HYsSpF0Uei7UeVKTY9G9cX9peNZi9Xox7aE233qlFx+jeuL+w/Mpr9qDL1EEs1Kk7/xvWEfc3asRpFUdNq26xMsenXuJ6wv59p9n4V6qE3rbZvVqHiLMG4nrD/MNPsh5WphypTcZZgXF+5/dv9/jfUN/i1EnNj2YE7qEbh7t+4HnfgWLPqSLU2Xj0bF9iBnSWiJBINbx3HZ9AsoBu0G/mJxsKFTZwCFZx0ttkawM7ddY8PSqsZlKBqZIwcduOzY2+0Ay8KDcGubRB2g3NgJ+SBM3Ic7KJ2eRK/whqG10PpyBmw07HIGS2DKpaFXVwjeuUEo3JHnh37SF7DsZ/M9yzYc4UvEnujGfBjx8VudL5Y7AsLAat8d6KwR3GsglZTqW5oHLjdoNtEnAIabQ7kreZ+kxoMYudHBnw1Y4+ofdjlq+RwGaaMW81I0kzzb5yrSE+KOzG9BM39PKAXsNNl1Ne4b1SMpaF+125wJ5Vv9JG+KwWaOIr7fWNnNhqh1UdZ4SwBDWAPmroMjVg/6XCcj/bGQtBmvdUotYdjD7QKFPhaTWLXDelpZBmtFUHdbzTa2pYR3Vm3jAuaWey6N4GMGMKu27JCpHZgB5JvEXO0XG+/1aDHtZr65/1GwFiDIdj7cUR9pT6KikGfukhThca+20mf2N9jqwZRnNk5x07M9XvH29Ux7Dwqmi26lFrSa4a9TWTi8bxdycBj/AwnZt50z1geYYyln87OFS40hmLnk5o5/Z/U1e3s+ClnmkeKyJPcIK8fZTRkzeJoOHY+qRFkQZ66HfVNKLCd9Im9RZ4h/3XsLNi1VgT3BOxt01djZ1Iwxx5IRhs3yIu3mmRIzBcakRk9EQUOekPm4CwzHDv5Dy8tBYydP9ZgwoYcLmOWpIrRjoO7fpRJ6vwyFLvuRyCL9MZmfCOTQ91OesWu1dTaCHyxcx7k+0Xs/QHs+hLB3mywmrppHuTD82G3o5DSW2CDhnb43NtHYdcqyCgUhzculHl7KRM6fgg9PsNufMKMxNHYdQObdugufKfYuFF52PtxT991qLePwC4aEdYC9uPefk7sknM4+l2nbuvb3A8FY8QtB7A/zgq4gJN/vxGzFpQaw7tGUTnsv2hn45FqBewRzUx1P3RuH4U9ookndynIsFM9TRmNcntZ2Gmy0c9yO+kq+o7EzpqyMR3sLcntEXeh0T4/dg7I4rzdSMKQmRrTi8k/2iL/yPc2vu8u1/D0XfK4mRpztRoVl3O8Fe3SSTJKzNFaK6ofe9cklmi4t2fLNXbSTyrqPjR7UorQ7Kgs7K1eaP1LTEKvdx1v544UFhUjo66LnU0eyUpZ+66DXU/0zzqTfxb5V0b9K3/E4mwF1PW0Jv+Bxf4h1uRrhP1/FvuXKmDBR89lwWn7J/VU1xP2d75iFPu4Cp7z28yOn9dUXV8br2+bj6JW4mMW+5kdf1pTdX1h/1j0ulqNRPl7Y8af/6am6vrC/uj5Cn1MXn4DTssHdVXX26drPmfF3qiGHX9t7Piwrup6w84JaLsq5dDPxI6/qqu6/j5L161I+cYiv170h9qq6w87fayhMkt0b2hlf1yN34kpRV1/2A+UutKvjNyuzCJDKep6JPVclb6p6nfajFce1VZdj9j/o/5eHezvVGr/wLu6HrF/qVK/HvFL2iOurbo+0/HtVoXs+Aul3quvuj6xf1EhM/Y/q9bG62elbbwqyFQLsAO7i/0pZGoF2IEd2IEd2IEdAuwQYIcAOwTYIcAOAfYLkBvfukEvS+sr9sjSteXTLlqlVctV/bo7cGplfQnYJ1+Wr63Sy24O8CzYdZMbLy4Be3WFEBZgnRE7jZQh2BHkKxTlOcavSuTW2HkU6GPL1z5ZV+sru3yczptU4GDny8X71YufvLRCly5d+6dSuxRJ1Is3gH1yozzF+FXNdGV9tYid/ikNUuOj86sSCeiFD+XY6Upqztg1c8oB+q7LnwD7ZAphfumGifP6TQH7qjDWDfjYjZdW7JSO/NjBzqlhyWCnoLC7+nT39HQB7JclGumSkJUZfQH7ksG+vrSyrgzsp9bpXeyc5m/YIL/M2HWgyAsEYJ8w2V3ViEZ4u4t9qTilO4bd9XaDne5dcYefYuxL3+LaXXI7Q1u+tvtU8nqOnQne+Mtx7JTTV9avLVMuX1kvYF/+6/JZygJgv6Qov24majqIL0kBR9Pyvx7D/lRP6C3uHLuev6n1v9AUT78uFYP8ksJMvg6yVP05HLCPFzJ2lzngA3vNPF0We4AdAuwQYIcAOwTYIcAOAXbIpGOfsl/1/epoq3x1yroK7MA+Pvaj6ZHnT8b+/BR1FdiBHdiBHdiBHdiBHdiBHdiBHdiBHdiBHdiBHdiBHdiBHdiBHdiBHdiBHdiBHdiBHdiBvWTsjbZSKj7lpmFXBeaVpNka0ex6SC9Bu5HdfSE8TeFAiQLBkLvGMbCXgj3sRkdHraZr8kFbt5pRTmkU87ydc4OzYNeDpNGOgP0CsRtQLtchtm60gzNhP4ropNv6jNjpwhNvDOxesYcLDcuLI3TUbDR1zLXcIv1zxKE9i9tMp9W83243Wk1JD1F2mu/BHAOJ3Bo7j4KAWt9v63Yx3dG9xsFum3Lmua9HjB6BjYWgzU0juRDYPWC3LqZtbbC3HG+PTPwd8PZWU59pNWMOE9Qqkvtw1KDrg27I5wvYeaAEfM65hjCH3eDIwU5XHsVdwd6W99RsvwHsfrFn3u5gF9oWRxF7ZN005pM2alDjhdAkDX2wgD2S+9tj5hqe0gVHLnY+Q/owdjlHgwVBvrQgL9gpugeSmDUGMj3FXSJusAeGl2o+oFJAGSj6EmrA5wlcAXtgsLeDhnONnfc72PkZDRvkQ3lolOceYPc1pQuOxvP2IOPlntShOYqjoxHe7mIPilO6Y9jbjrdb7JI5LhB7dGyOSVOZfICPKmOcrpVavfoq4CSJD8ntwdFw7HTBURQcxfpIeNeevs61u+T2iHouU4AidvcaB7ttSnduNbsF7PfDATNeMPbTQEr7MRctnrl69bFcE5mR175LOLqFmXxwNAI7X0pXxs4CDg8cM4wj6bm+X/fWMezONQ5225Rfg2KQtw+bXOyyWDX+osWzVa/Tujhrpx2XVrdHFH72m25UZ5DF6jXIwj5HeclTWfXKo4CORbEe6EEgg91H9TqF2FuxlIcTgJ0yTe6JBrtTvVI2s/GKwgP97FSvOXZF/2KO6F6q12n0dlogOj2zXQT2qBB2DPa8ehUPX8jKGD2lLcxnc+yUwigLxJGf6hU7cGViF0K2ejXY8+q1IbP7wJYxsmiRV69OkDfJP479VK/AXj72Y96eV6+FzQwNaJ8XLYZ5u4vdR/UK7JeB3VavXOPGLXv6elSsXiWPqwJ2P9Vrqdh51sJLChK6BuoVt04drwqhqTCNYJnW0lgvus5kY8+q18jZpuKZWLF6pV7eLXq7n+q1VOxxYGkOYB/cXB8LO68TaT/hSv6WTF5avXCCsE929Vom9iA+Gol9cHN9HOwcJJ3bmoXgGNjPWL2WiF2YONhlbSKSYjPfXJdt+WLxOXxzfWAuYzso2BvNBrz9bNVridiFAuf2iLDbtYmY69Vscz3KF5ZP21zPQ0WcdZLPCPbxojx24MrBHvZarrdnaxPh9VtmD5beZRt1BezDN9cHsdPcKM6SRRwA++Rht2sTEc9YzeZ6ti1fwD58c33oPIC2b4B9crCbIF/wdqljenxMNteHe/vwzXUHdVCYtyLITw7241M6szah8csIMJvrdlveWXMYtbnuRHne0Y31/7ghpnSTg10ysDOTlyl5TLtMsg8voTrK9hNO2lyXlFGYsJptRjNsUMBNCPYx109OG0TthtfHAXtZq3S0F+yRe3zqSjCwTwL2iRZgB3ZgB3ZgB3ZgB3ZgB3ZgB3ZgB3ZgB3ZgB3ZgB3ZgB3Zgrwh2/I1X/GlfYK8Hdkgt/347BNghwA4BdgiwQ4AdAuwQYIcAOwTYIcAOAXYIsEN8YYdMswA7sPfrKkU71Exqi/1AqQNgr508VOohsNdO3lLqLWCvm6zRJGcN2Gsm9wj7PWCvlzzu8td+Pgb2Wsm7Usq+C+y1ko8E+0fAXid5sCfY9x4Ae43kjl2wvAPsNZKmxd4E9vpI+KbF/mYI7LWRW/m21C1gr5EcyA7cQV0Ld2y8AjuwAzuwAzuwAzuwAzuwAzuwA/vEyqPnstWa7Z8Ae23ktxn2z+Ht9ZH9DPtPgb1G8ntD/ee/AfYayT2D/QNM6eokvzbYHwJ7reRngv1XwF4reZmp/wF1e73kDQ39x7X9SFV9V+luk7d/DOw1k99p6lceAXvN5B2N/cM+sNdNfqnU94G9dvILpd4D9trJZ9h4FcF3OeELyiD1wf4EMrUC7MAO7MAO7MAOAXYIsEOAHQLsEGCHADsE2CHADgF2CLBDgB0C7CfI5nbv5Abh1R35YUup7U1gnw7sO9+87bDcuhqOwk6nNl998qTXA/bqS+/O1a2zYM+cHtinAPva7U1BvbanQ3hPKbW19s014a8PqZ0ce09eFB3c3OaIH179Ynt7U9rxsS9ur01LNphq7Fu9J5uEaodY3hHaBnv4avhka3vTuvnankQC8vbNbR0h+Byxt+30id7eGv08LGoA++QIMyWQva0syGfeLsEgi+7am3sGO5/VJ0KbIHS7NZoj6Gs3t3f4PbBPcIznvwGTu3TB2yme761l2Am8Ps3YezxktvicabdDQ0FHDor19B7YJ3hC12Oamdu62M3PDnZ24qK372TX7Gw73o4p3WQX7YyodzXc0e5pcjslbvJr+rmXeXvY2xTCeW6ngGCw63Z0LLyqb9OjYXAP2Ce4aJcZNzHf4em3jtBb/OM9CfKv5t5uJu+UF2Qmr+lmQV63oxN7OzQ97PE5YK+PTMFUDtjHKwp6m7a4B/Y6ebquCqZoBQ/YaynADuzADuzADuwQYIcAOwTYIcAOAXYIsEMmGDsE30IJqQd2CL5hGgLsEGCHADsE2CHADgF2CLBDgB0C7BBgh5Qo/xdgAFa1YsClg4fBAAAAAElFTkSuQmCC" alt="">
图13-6 Kubernetes存储架构</p></div> <p>后端的真实存储依次经过Provision、Attach、Mount操作之后，就形成了可以在容器中挂载的Volume，当存储的生命周期完结，依次经过Unmount、Detach、Delete操作之后，Volume便能够被存储系统回收。对于某些存储来说，其中有一些操作可能是无效的，譬如NFS，实际使用并不需要Attach，此时存储插件只需将Attach实现为空操作即可。</p> <h2 id="flexvolume与csi">FlexVolume与CSI</h2> <p>Kubernetes目前同时支持<a href="https://github.com/kubernetes/community/blob/master/contributors/devel/sig-storage/flexvolume.md" target="_blank" rel="noopener noreferrer">FlexVolume<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>与<a href="https://github.com/container-storage-interface/spec/blob/master/spec.md" target="_blank" rel="noopener noreferrer">CSI<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>（Container Storage Interface）两套独立的存储扩展机制。FlexVolume是Kubernetes很早期版本（1.2版开始提供，1.8版达到GA状态）就开始支持的扩展机制，它是只针对Kubernetes的私有的存储扩展，目前已经处于冻结状态，可以正常使用但不再发展新功能了。CSI则是从Kubernetes 1.9开始加入（1.13版本达到GA状态）的扩展机制，如同之前介绍过的CRI和CNI那样，CSI是公开的技术规范，任何容器运行时、容器编排引擎只要愿意支持，都可以使用CSI规范去扩展自己的存储能力，这是目前Kubernetes重点发展的扩展机制。</p> <p>由于是专门为Kubernetes量身订造的，所以FlexVolume的实现逻辑与上一节介绍的Kubernetes存储架构高度一致。FlexVolume驱动其实就是一个实现了Attach、Detach、Mount、Unmount操作的可执行文件（甚至可以仅仅是个Shell脚本）而已，该可执行文件应该存放在集群每个节点的<code>/usr/libexec/kubernetes/kubelet-plugins/volume/exec</code>目录里，其工作过程也就是当AD控制器和Volume管理器需要进行Attach、Detach、Mount、Unmount操作时自动调用它的对应方法接口，如图13-7所示。</p> <div class="custom-block center"><p><img src="/assets/img/flexvolume.67a67c26.png" alt="">
图13-7 FlexVolume Driver工作过程（<a href="https://laptrinhx.com/kubernetes-volume-plugins-evolution-from-flexvolume-to-csi-2724482856/" target="_blank" rel="noopener noreferrer">图片来源<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>）</p></div> <p>如果仅仅考虑支持最基本的Static Provisioning，那实现一个FlexVolume Driver确实是非常简单的。然而也是由于FlexVolume过于简单了，导致它应用起来会有诸多不便之处，譬如：</p> <ul><li>FlexVolume并不是全功能的驱动：FlexVolume不包含Provision和Delete操作，也就无法直接用于Dynamic Provisioning，除非你愿意再单独编写一个External Provisioner。</li> <li>FlexVolume部署维护都相对繁琐：FlexVolume是独立于Kubernetes的可执行文件，当集群节点增加时，需要由管理员在新节点上部署FlexVolume Driver，有经验的系统管理员通常会专门编写一个DaemonSet来代替人工来完成这项任务。</li> <li>FlexVolume实现复杂交互也相对繁琐：FlexVolume的每一次操作，都是对插件可执行文件的一次独立调用，这种插件实现方式在各种操作需要相互通讯时很会别扭。譬如你希望在执行Mount操作的时候，生成一些额外的状态信息，这些信息在后面执行Unmount操作时去使用，那就只能把信息记录在某个约定好的临时文件中，对于一个面向生产的容器编排系统，这样的做法实在是过于简陋了。</li></ul> <p>相比起FlexVolume的种种不足，CSI可算是一个十分完善的存储扩展规范，这里“十分完善”可不是客套话，根据GitHub的自动代码行统计，FlexVolume的规范文档仅有155行，而CSI则长达2704行。总体上看，CSI规范可以分为需要容器系统去实现的组件，以及需要存储提供商去实现的组件两大部分。前者包括了存储整体架构、Volume的生命周期模型、驱动注册、Volume创建、挂载、扩容、快照、度量等内容，这些Kubernetes都已经完整地实现了，大体上包括以下几个组件：</p> <ul><li><a href="https://github.com/kubernetes-csi/driver-registrar" target="_blank" rel="noopener noreferrer">Driver Register<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>：负责注册第三方插件，CSI 0.3版本之后已经处于Deprecated状态，将会被<a href="https://kubernetes-csi.github.io/docs/node-driver-registrar.html" target="_blank" rel="noopener noreferrer">Node Driver Register<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>所取代。</li> <li><a href="https://github.com/kubernetes-csi/external-provisioner" target="_blank" rel="noopener noreferrer">External Provisioner<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>：调用第三方插件的接口来完成数据卷的创建与删除功能。</li> <li><a href="https://github.com/kubernetes-csi/external-attacher" target="_blank" rel="noopener noreferrer">External Attacher<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>：调用第三方插件的接口来完成数据卷的挂载和操作。</li> <li><a href="https://github.com/kubernetes-csi/external-resizer" target="_blank" rel="noopener noreferrer">External Resizer<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>：调用第三方插件的接口来完成数据卷的扩容操作。</li> <li><a href="https://github.com/kubernetes-csi/external-snapshotter" target="_blank" rel="noopener noreferrer">External Snapshotter<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>：调用第三方插件的接口来完成快照的创建和删除。</li> <li><a href="https://github.com/kubernetes-csi/external-health-monitor" target="_blank" rel="noopener noreferrer">External Health Monitor<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>：调用第三方插件的接口来提供度量监控数据。</li></ul> <p>需要存储提供商去实现的组件才是CSI的主体部分，即前文中多次提到的“第三方插件”。这部分着重定义了外部存储挂载到容器过程中所涉及操作的抽象接口和具体的通讯方式，主要包括以下三个gRPC接口：</p> <ul><li><strong>CSI Identity接口</strong>：用于描述插件的基本信息，譬如插件版本号、插件所支持的CSI规范版本、插件是否支持存储卷创建、删除功能、是否支持存储卷挂载功能，等等。此外Identity接口还用于检查插件的健康状态，开发者可以通过实现Probe接口对外提供存储的健康度量信息。</li> <li><strong>CSI Controller接口</strong>：用于从存储系统的角度对存储资源进行管理，譬如准备和移除存储（Provision、Delete操作）、附加与分离存储（Attach、Detach操作）、对存储进行快照，等等。存储插件并不一定要实现这个接口的所有方法，对于存储本身就不支持的功能，可以在CSI Identity接口中声明为不提供。</li> <li><strong>CSI Node接口</strong>：用于从集群节点的角度对存储资源进行操作，譬如存储卷的分区和格式化、将存储卷挂载到指定目录上、或者将存储卷从指定目录上卸载，等等。</li></ul> <div class="custom-block center"><p><img src="/assets/img/csi-arch.cc63ab2f.png" alt="">
图13-8 CSI组件架构（<a href="https://medium.com/google-cloud/understanding-the-container-storage-interface-csi-ddbeb966a3b" target="_blank" rel="noopener noreferrer">图片来源<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>）</p></div> <p>与FlexVolume以单独的可执行程序的存在形式不同，CSI插件本身便是由一组标准的Kubernetes资源所构成，CSI Controller接口是一个以StatefulSet方式部署的gRPC服务，CSI Node接口则是基于DaemonSet方式部署的gRPC服务。这意味着虽然CSI实现起来要比FlexVolume复杂得多，但是却很容易安装——如同安装CNI插件及其它应用那样，直接载入Manifest文件即可，也不会遇到FlexVolume那样需要人工运维，或者自己编写DaemonSet来维护集群节点变更的问题。此外，通过gRPC协议传递参数比通过命令行参数传递参数更加严谨，灵活和可靠，最起码不会出现多个接口之间协作只能写临时文件这样的尴尬状况。</p> <h2 id="从in-tree到out-of-tree">从In-Tree到Out-of-Tree</h2> <p>Kubernetes原本曾内置了相当多的In-Tree的存储驱动，时间上甚至还早于Docker宣布支持卷驱动功能，这种策略使得Kubernetes能够在云存储提供商发布官方驱动之前就将其纳入到支持范围中，同时减轻了管理员维护的工作量，为它在诞生初期快速占领市场做出了一定的贡献。但是，这种策略也让Kubernetes丧失了随时添加或修改存储驱动的灵活性，只能在更新大版本时才能加入或者修改驱动，导致云存储提供商被迫要与Kubernetes的发版节奏保持一致。此外，还涉及到第三方存储代码混杂在Kubernetes二进制文件中可能引起的可靠性及安全性问题。因此，当Kubernetes成为市场主流以后——准确的时间点是从1.14版本开始，Kubernetes启动了In-Tree存储驱动的CSI外置迁移工作，按照计划，在1.21到1.22版本（大约在2021年中期）时，Kubernetes中主要的存储驱动，如AWS EBS、GCE PD、vSphere等都会迁移至符合CSI规范的Out-of-Tree实现，不再提供In-Tree的支持。这种做法在设计上无疑是正确的，然而，这又面临了此前提过的该如何兼容旧功能的策略问题，譬如下面YAML定义了一个Pod：</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>pod<span class="token punctuation">-</span>example
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>latest
    <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> html<span class="token punctuation">-</span>pages<span class="token punctuation">-</span>volume
      <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /usr/share/nginx/html
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> config<span class="token punctuation">-</span>volume
      <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /etc/nginx
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> html<span class="token punctuation">-</span>pages<span class="token punctuation">-</span>volume
      <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>                 <span class="token comment"># 来自本地的存储</span>
        <span class="token key atrule">path</span><span class="token punctuation">:</span> /srv/nginx/html
        <span class="token key atrule">type</span><span class="token punctuation">:</span> Directory
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> config<span class="token punctuation">-</span>volume
      <span class="token key atrule">awsElasticBlockStore</span><span class="token punctuation">:</span>     <span class="token comment"># 来自AWS ESB的存储</span>
        <span class="token key atrule">volumeID</span><span class="token punctuation">:</span> vol<span class="token punctuation">-</span>0b39e0b08745caef4
        <span class="token key atrule">fsType</span><span class="token punctuation">:</span> ext4
</code></pre></div><p>其中用到了类型为hostPath的Volume，这相当于Docker中驱动类型为local的Volume，不需要专门的驱动；而类型为awsElasticBlockStore的Volume，从名字上就能看出是指存储驱动为AWS EBS的Volume，当CSI迁移完成，awsElasticBlockStore从In-Tree卷驱动中移除掉之后，它就应该按照CSI的写法改写成如下形式：</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> config<span class="token punctuation">-</span>volume
      <span class="token key atrule">csi</span><span class="token punctuation">:</span>
        <span class="token key atrule">driver</span><span class="token punctuation">:</span> ebs.csi.aws.com
        <span class="token key atrule">volumeAttributes</span><span class="token punctuation">:</span> 
          <span class="token punctuation">-</span> <span class="token key atrule">volumeID</span><span class="token punctuation">:</span> vol<span class="token punctuation">-</span>0b39e0b08745caef4
          <span class="token punctuation">-</span> <span class="token key atrule">fsType</span><span class="token punctuation">:</span> ext4
</code></pre></div><p>这样的要求有悖于升级版本不应影响还在大范围使用的已有功能这条原则，所以Kubernetes 1.17中又提出了称为<a href="https://kubernetes.io/blog/2019/12/09/kubernetes-1-17-feature-csi-migration-beta/" target="_blank" rel="noopener noreferrer">CSIMigration<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>的解决方案，让Out-of-Tree的驱动能够自动伪装成In-Tree的接口来提供服务。
笔者专门花这两段来介绍Volume的CSI迁移，倒不是由于它算是多么重要的特性，而是这种兼容性设计本身就是Kubernetes设计理念的一个缩影，在Kubernetes的代码与功能中随处可见。好的设计需要权衡多个方面的利益，很多时候都得顾及现实的影响，要求设计向现实妥协，而不能仅仅考虑理论最优的方案。</p> <h2 id="容器插件生态">容器插件生态</h2> <p>现在几乎所有云计算厂商都支持自家的容器通过CSI规范去接入外部存储，能够应用于CSI与FlexVolume的存储插件更是多达数十上百款，其中部分如下图所示，已经算是形成了初步的生态环境。限于篇幅，笔者不打算去谈论各种CSI存储插件的细节，这节会采取与CNI网络插件类似的讲述方式，以不同的存储类型为线索，介绍其中有代表性的实现。</p> <div class="custom-block center"><p><img src="/assets/img/csi-protects.ffd632de.png" alt="">
图13-9 部分容器存储提供商（<a href="https://blog.dellemc.com/en-us/kubernetes-data-protection-hits-mainstream-with-container-storage-interface-csi-117/" target="_blank" rel="noopener noreferrer">图片来源<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>）</p></div> <p>目前出现过的存储系统和设备均可以划分到块存储、文件存储和对象存储这三种存储类型之中，划分的根本依据其实并非各种存储是如何储存数据的——那完全是存储系统私有的事情，更合理的划分依据是各种存储提供何种形式的接口供外部访问数据，不同的外部访问接口将反过来影响到存储的内部结构、性能与功能表现。虽然块存储、文件存储和对象存储可以彼此协同工作，但它们各自都有自己明确的擅长领域与优缺点，理解它们的工作原理，因地制宜地选择最适合的存储才能让系统达到最佳的工作状态。笔者按照它们出现的时间顺序分别介绍如下：</p> <ul><li><p><strong>块存储</strong>：块存储是数据存储的最古老形式，数据都储存在固定长度的一个或多个<a href="https://en.wikipedia.org/wiki/Block_(data_storage)" target="_blank" rel="noopener noreferrer">块<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>（Block）中，想要读写访问数据，就必须使用与存储相匹配的协议（SCSI、SATA、SAS、FCP、FCoE、iSCSI……）来进行的。如果你是按顺序阅读本书内容的话，那笔者建议你类比上一章网络通讯中<a href="/immutable-infrastructure/network/linux-vnet.html#网络通讯模型">网络栈</a>的数据流动过程，把存储设备中由块构成的信息流与网络设备中由数据包构成的信息流进行对比，事实上，像iSCSI这种协议真的就是建设在TCP/IP网络之上，上层以SCSI作为应用层协议对外提供服务的。</p> <p>我们熟悉的硬盘就是最经典的块存储设备，以机械硬盘为例，一个块就是一个扇区，大小通常在512 Bytes至4096 Bytes之间。老式机械硬盘用<a href="https://en.wikipedia.org/wiki/Cylinder-head-sector" target="_blank" rel="noopener noreferrer">柱面-磁头-扇区号<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>（Cylinder-Head-Sector，CHS）组成的编号进行寻址，现代机械硬盘只用一个<a href="https://en.wikipedia.org/wiki/Logical_block_addressing" target="_blank" rel="noopener noreferrer">逻辑块编号<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>（Logical Block Addressing，LBA）进行寻址。为了便于管理，硬盘通常会以多个块（这些块甚至可以来自不同的物理设备，譬如磁盘阵列的情况）来组成一个逻辑分区（Partition），将分区进行<a href="https://en.wikipedia.org/wiki/Disk_formatting#High-level_formatting" target="_blank" rel="noopener noreferrer">高级格式化<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>之后就形成了卷（Volume），这便与上节“<a href="/immutable-infrastructure/storage/storage-evolution.html">Kubernetes存储设计</a>”中提到“Volume是源于操作系统的概念”衔接了起来。</p> <p>块存储由于贴近底层硬件，没有文件、目录、访问权限等的牵绊，所以性能通常都是最优秀的，吞吐量高，延迟低。尽管人类作为信息系统的最终用户，并不会直接面对块来操作数据，多数应用程序也是基于文件而不是块来读写数据的，但是操作系统内核中许多地方就直接通过<a href="https://en.wikipedia.org/wiki/Device_file#BLOCKDEV" target="_blank" rel="noopener noreferrer">块设备<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>（Block Device）接口来访问硬盘，一些追求I/O性能的软件，譬如高性能的数据库也会支持直接读写块设备以提升磁盘I/O。块存储的特点是具有排它性，一旦块设备被某个客户端挂载后，其它客户端就无法再访问上面的数据了，因此，Kubernetes中挂载的块存储大多访问模式都要求必须是RWO（ReadWriteOnce）的。</p></li> <li><p><strong>文件存储</strong>：文件存储是最贴近人类用户的数据存储形式，数据存储在长度不固定的文件之中，用户可以针对文件进行新增、写入、追加、移动、复制、删除、重命名等各种操作，通常文件存储还会提供有文件查找、目录管理、权限控制等额外的高级功能。文件存储的访问不像块存储那样有五花八门的协议，<a href="https://en.wikipedia.org/wiki/POSIX" target="_blank" rel="noopener noreferrer">POSIX<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>接口（Portable Operating System Interface，POSIX）已经成为了事实标准，被各种商用的存储系统和操作系统共同支持。具体POSIX的文件操作接口笔者就不去举例罗列了，你不妨类比Linux下的各种文件管理命令来自行想象一下。</p> <p>绝大多数传统的文件存储都是基于块存储之上去实现的，“文件”这个概念的出现是因为“块”对人类用户来说实在是过于难以使用、难以管理了。可以近似地认为文件是由块所组成的更高级存储单位。对于固定不会发生变动的文件，直接让每个文件连续占用若干个块，在文件头尾加入标志区分即可，磁带、CD-ROM、DVD-ROM就采用了由连续块来构成文件的存储方案；但对于可能发生变动的场景，就必须考虑如何跨多个不连续的块来构成为文件。这种需求在数据结构角度看只需在每个块中记录好下一个块的地址，形成链表结构即可满足。但是链表的缺点是只能依次顺序访问，这样访问文件中任何内容都要从头读取多个块，显然过于低效了。真正被广泛运用的解决方案是把形成链表的指针整合起来统一存放，这便形成了<a href="https://en.wikipedia.org/wiki/File_Allocation_Table" target="_blank" rel="noopener noreferrer">文件分配表<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>（File Allocation Table，FAT）的概念。既然已经有了专门组织块结构来构成文件的分配表，那在表中再加入其他控制信息，就能很方便地扩展出更多的高级功能，譬如除了文件占用的块地址信息外，加上文件的逻辑位置就形成了目录，加上文件的访问标志就形成了权限，还可以再加上文件的名称、创建时间、所有者、修改者等一系列的元数据信息来构成其他应用形式。人们把定义文件分配表应该如何实现、储存哪些信息、提供什么功能的标准称为<a href="https://en.wikipedia.org/wiki/File_system" target="_blank" rel="noopener noreferrer">文件系统<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>（File System），FAT32、NTFS、exFAT、ext2/3/4、XFS、BTRFS等都是很常用的文件系统。而前面介绍存储插件接口时提到的对分区进行高级格式化操作，实际上就是在初始化一套空白的文件系统，供后续用户与应用程序访问。</p> <p>文件存储相对于块存储来说是更高层次的存储类型，加入目录、权限等元素后形成的树状结构以及路径访问方式方便了人类理解、记忆和访问；文件系统能够提供哪个进程打开或正在读写某个文件的信息，这也有利于文件的共享处理。但在另一方面，计算机需要把路径进行分解，然后逐级向下查找，最后才能查找到需要的文件，要从文件分配表中确定具体数据存储的位置，要判断文件的访问权限，要记录每次修改文件的用户与时间，这些额外操作对于性能产生负面影响也是无可避免的，因此，如果一个系统选择不采用文件存储的话，那磁盘I/O性能一般就是最主要的决定因素。</p></li> <li><p><strong>对象储存</strong>：<a href="https://en.wikipedia.org/wiki/Object_storage" target="_blank" rel="noopener noreferrer">对象存储<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>是相对较新的数据存储形式，是一种随着云数据中心的兴起而发展起来的存储，是以非结构化数据为目标的存储方案。这里的“对象”可以理解为一个元数据及与其配对的一个逻辑数据块的组合，元数据提供了对象所包含的上下文信息，譬如数据的类型、大小、权限、创建人、创建时间，等等，数据块则存储了对象的具体内容。你也可以简单地理解为数据和元数据这两样东西共同构成了一个对象。每个对象都有属于自己的全局唯一标识，这个标识会直接开放给最终用户使用，作为访问该对象的主要凭据，通常会是UUID的形式。对象存储的访问接口就是根据该唯一标识，对逻辑数据块进行的读写删除操作，通常接口都会十分简单，甚至连修改操作都不会提供。</p> <p>对象存储基本上只会在分布式存储系统之上去实现，由于对象存储天生就有明确的“元数据”概念，不必依靠文件系统来提供数据的描述信息，因此，完全可以将一大批对象的元数据集中存放在某一台（组）服务器上，再辅以多台OSD（Object Storage Device）服务器来存储对象的数据块部分。当外部要访问对象时，多台OSD能够同时对外发送数据，因此对象存储不仅易于共享、容量庞大，还能提供非常高的吞吐量。不过，由于需要先经过元数据查询确定OSD存放对象的确切位置，该过程可能涉及多次网络传输，延迟方面就会表现得相对较差。</p> <p>由于对象的元数据仅描述对象本身的信息，与其他对象都没有关联，换而言之每个对象都是相互独立的，自然也就不存在目录的概念，可见对象存储天然就是扁平化的，与软件系统中很常见的K/V访问相类似，不过许多对象存储会提供Bucket的概念，用户可以在逻辑上把它看作是“单层的目录”来使用。由于对象存储天生的分布式特性，以及极其低廉的扩展成本，使它很适合于<a href="/architect-perspective/general-architecture/diversion-system/cdn.html">CDN</a>一类的应用，拿来存放图片、音视频等媒体内容，以及网页、脚本等静态资源。</p></li></ul> <p>理解了三种存储类型的基本原理后，接下来又到了治疗选择困难症的环节。主流的云计算厂商，譬如国内的阿里云、腾讯云、华为云都有自己专门的块存储、文件存储和对象存储服务，关于选择服务提供商的问题，笔者不作建议，你根据价格、合作关系、技术和品牌知名度等因素自行去处理。关于应该选择三种存储类型中哪一种的问题，笔者这里以世界云计算市场占有率第一的亚马逊为例，简要对比介绍它不同存储类型产品的差异：</p> <ul><li><p>亚马逊的块存储服务是<a href="https://amazonaws-china.com/cn/ebs" target="_blank" rel="noopener noreferrer">Amazon Elastic Block Store<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>（AWS EBS），你购买EBS之后，在EC2（亚马逊的云计算主机）里看见的是一块原始的、未格式化的块设备。这点就决定了EBS并不能做为一个独立存储而存在，它总是和EC2同时被创建的，EC2的操作系统也只能安装在EBS之上。EBS的大小理论上取决于建立的分区方案，即块大小乘以块数量。MBR分区的块数量是2<sup>32</sup>，块大小通常是512 Bytes，总容量为2 TB；GPT分区的块数量是2<sup>64</sup>，块大小通常是4096 Bytes，总容量64 ZB。当然这是理论值，64 ZB已经超过了世界上所有信息的总和，不会有操作系统支持这种离谱的容量，AWS也设置了上限是16 TB，在此范围内的实际值就只取决于你的预算额度；EBS的性能取决于你选择的存储介质类型（SSD、HDD）还有优化类型（通用性、预置型、吞吐量优化、冷存储优化等），这也将直接影响存储的费用成本。</p> <p>EBS适合作为系统引导卷，适合追求磁盘I/O的大型工作负载以及追求低时延的应用，譬如Oracle等可以直接访问块设备的大型数据库更是尤其合适。但EBS只允许被单个节点挂载，难以共享，这点在单机时代是天经地义的，但在云计算和分布式时代就成为了很要命的缺陷。除了少数特殊的工作负载外（如前面说的Oracle数据库），笔者并不建议将它作为容器编排系统的主要外置存储来使用。</p></li> <li><p>亚马逊的文件存储服务是<a href="https://amazonaws-china.com/cn/efs/" target="_blank" rel="noopener noreferrer">Amazon Elastic File System<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>（AWS EFS），你购买EFS之后，只要在EFS控制台上创建好文件系统，并且管理好网络信息（如IP地址、子网）就可以直接使用，无需依附于任何EC2云主机。EFS本质是完全托管在云端的<a href="https://en.wikipedia.org/wiki/Network_File_System" target="_blank" rel="noopener noreferrer">网络文件系统<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>（Network File System，NFS），可以在任何兼容POSIX的操作系统中直接挂载它，而不会在<code>/dev</code>中看到新设备存在。按照本节开头Kubernetes存储架构中的操作来说就是你只需要考虑Mount，无需考虑Attach了。</p> <p>得益于NFS的天然特性，EFS的扩缩可以是完全自动、实时的，创建新文件时无需预置存储，删除已有文件时也不必手动缩容以节省费用。在高性能网络的支持下，EFS的性能已经能够达到相当高的水平，尽管由于网络访问的限制，性能最高的EFS依然比不过最高水平的EBS，但仍然能充分满足绝大多数应用运行的需要。还有最重要的一点优势是由于脱离了块设备的束缚，EFS能够轻易地被成百上千个EC2实例共享，考虑到EFS的性能、动态弹性、可共享这些因素，笔者给出的明确建议是它可以作为大部分容器工作负载的首选存储。</p></li> <li><p>亚马逊的对象存储服务是<a href="https://amazonaws-china.com/cn/s3/" target="_blank" rel="noopener noreferrer">Amazon Simple Storage Service<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>（AWS S3），S3通常是以REST Endpoint的形式对外部提供文件访问服务的，这种方式下你应该直接使用程序代码来访问S3，而不是靠操作系统或者容器编排系统去挂载它。如果你真的希望这样做，也可以通过存储网关（如<a href="https://amazonaws-china.com/cn/storagegateway" target="_blank" rel="noopener noreferrer">AWS Storage Gateway<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>）将S3的存储能力转换为NFS、SMB、iSCSI等访问协议，经过转换后，操作系统或者容器就能够将其作为Volume来挂载了。</p> <p>S3也许是AWS最出名、使用面最广的存储服务，这个结果不是由于它的性能优异，事实上S3的性能比起EBS和EFS来说是相对最差的，但它的优势在于它名字中“Simple”所标榜的简单，我们挂载外部存储的目的十有八九就是为了给程序提供存储服务，使用S3不必用写一行代码就能够直接通过HTTP Endpoint进行读写访问，且完全不需要考虑容量、维护和数据丢失的风险，这就是简单的价值。S3的另一大优势就是它的价格相对于EBS和EFS来说往往要低一至两个数量级，因此程序的备份还原、数据归档、灾难恢复、静态页面的托管、多媒体分发等功能就非常适合使用S3来完成。</p></li></ul> <div class="custom-block center"><p><img src="/assets/img/aws.a3fee57b.png" alt="">
图13-10 AWS的S3、EFS、EBS对比（图片来自AWS的<a href="https://blog.dellemc.com/en-us/kubernetes-data-protection-hits-mainstream-with-container-storage-interface-csi-117/" target="_blank" rel="noopener noreferrer">销售材料<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>）</p></div> <p>图13-10是截取自亚马逊销售材料中三种存储的对比，从目前的存储技术发展来看，不会有哪一种存储方案能够包打天下。不同业务系统的场景需求不同，对存储的诉求会不同，选择自然会不同。</p></div> <footer class="page-edit"><!----> <div class="git-hub-star"><span class="prefix">
      Kudos to
      <span style="position:relative;top:4px;right:-4px;"><a href="https://github.com/fenixsoft/awesome-fenix" aria-label="Star fenixsoft/awesome-fenix on GitHub" data-icon="octicon-star" data-show-count="true">
      Star
    </a></span></span></div> <div class="last-updated"><span class="prefix">总字数:</span> <span class="words">8,483</span> <span class="prefix">字　</span> <span class="prefix">最后更新:</span> <span class="time">2/20/2021, 12:25:44 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
    ←
    <a href="/immutable-infrastructure/storage/storage-evolution.html" class="prev">
      Kubernetes存储设计
    </a></span> <span class="next"><a href="/immutable-infrastructure/schedule/hardware-schedule.html">
      资源与调度
    </a>
    →
  </span></p></div> </main></div><div class="global-ui"><div></div><!----></div></div>
    <script src="/assets/js/app.83b03387.js" defer></script><script src="/assets/js/3.9ff08370.js" defer></script><script src="/assets/js/6.f55cdd7e.js" defer></script><script src="/assets/js/12.b8693f70.js" defer></script><script src="/assets/js/46.b10d8f94.js" defer></script>
  </body>
</html>

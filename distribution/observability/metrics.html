<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>聚合度量 | 软件架构探索：The Fenix Project</title>
    <meta name="description" content="现代软件架构探索">
    <meta name="generator" content="VuePress 1.4.0">
    <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico">
    
    <link rel="preload" href="/assets/css/0.styles.acccec19.css" as="style"><link rel="preload" href="/assets/js/app.0156b363.js" as="script"><link rel="preload" href="/assets/js/3.0a6c0dd5.js" as="script"><link rel="preload" href="/assets/js/6.b08f2b32.js" as="script"><link rel="preload" href="/assets/js/37.6a2be385.js" as="script"><link rel="preload" href="/assets/js/45.23f3e077.js" as="script"><link rel="prefetch" href="/assets/js/1.dc887e24.js"><link rel="prefetch" href="/assets/js/10.8c29aeee.js"><link rel="prefetch" href="/assets/js/100.85428be9.js"><link rel="prefetch" href="/assets/js/101.eb438686.js"><link rel="prefetch" href="/assets/js/102.c57a5b1c.js"><link rel="prefetch" href="/assets/js/103.c15aedbe.js"><link rel="prefetch" href="/assets/js/104.7ae8c35a.js"><link rel="prefetch" href="/assets/js/105.39417a45.js"><link rel="prefetch" href="/assets/js/106.fd307fcd.js"><link rel="prefetch" href="/assets/js/107.ad07cca9.js"><link rel="prefetch" href="/assets/js/108.8efdca60.js"><link rel="prefetch" href="/assets/js/109.2fb9ef25.js"><link rel="prefetch" href="/assets/js/11.4d9d24c5.js"><link rel="prefetch" href="/assets/js/110.66d715b7.js"><link rel="prefetch" href="/assets/js/111.308b2cd7.js"><link rel="prefetch" href="/assets/js/112.afc9fea1.js"><link rel="prefetch" href="/assets/js/113.357804eb.js"><link rel="prefetch" href="/assets/js/114.3e855e2c.js"><link rel="prefetch" href="/assets/js/115.0ace0a23.js"><link rel="prefetch" href="/assets/js/116.d246d523.js"><link rel="prefetch" href="/assets/js/117.530e3cc4.js"><link rel="prefetch" href="/assets/js/118.1c9db2c7.js"><link rel="prefetch" href="/assets/js/119.4d39cc73.js"><link rel="prefetch" href="/assets/js/12.b7ce9e76.js"><link rel="prefetch" href="/assets/js/120.5dd456b9.js"><link rel="prefetch" href="/assets/js/121.4eb6edee.js"><link rel="prefetch" href="/assets/js/122.7a0350a0.js"><link rel="prefetch" href="/assets/js/123.eebedffd.js"><link rel="prefetch" href="/assets/js/124.2539203a.js"><link rel="prefetch" href="/assets/js/125.f0fb42e8.js"><link rel="prefetch" href="/assets/js/126.e52532da.js"><link rel="prefetch" href="/assets/js/127.1e47ee21.js"><link rel="prefetch" href="/assets/js/128.0ab1b42e.js"><link rel="prefetch" href="/assets/js/129.deea32f4.js"><link rel="prefetch" href="/assets/js/13.cfe7f46c.js"><link rel="prefetch" href="/assets/js/130.1baf67bb.js"><link rel="prefetch" href="/assets/js/131.5ea55bae.js"><link rel="prefetch" href="/assets/js/132.20a90d9f.js"><link rel="prefetch" href="/assets/js/133.79de27d9.js"><link rel="prefetch" href="/assets/js/134.19b9a27d.js"><link rel="prefetch" href="/assets/js/135.650707ec.js"><link rel="prefetch" href="/assets/js/136.c68ca7b7.js"><link rel="prefetch" href="/assets/js/137.fdb4726b.js"><link rel="prefetch" href="/assets/js/138.f656c45a.js"><link rel="prefetch" href="/assets/js/139.b08b645f.js"><link rel="prefetch" href="/assets/js/14.e6df2b05.js"><link rel="prefetch" href="/assets/js/140.5f7b0b42.js"><link rel="prefetch" href="/assets/js/141.a7608767.js"><link rel="prefetch" href="/assets/js/142.4c73261d.js"><link rel="prefetch" href="/assets/js/143.2f9bcf81.js"><link rel="prefetch" href="/assets/js/144.00e8cd0d.js"><link rel="prefetch" href="/assets/js/145.3b28cd5c.js"><link rel="prefetch" href="/assets/js/146.8caf4aab.js"><link rel="prefetch" href="/assets/js/147.eb8cf370.js"><link rel="prefetch" href="/assets/js/148.087c9f7e.js"><link rel="prefetch" href="/assets/js/149.6b00a8fe.js"><link rel="prefetch" href="/assets/js/15.f7af79b7.js"><link rel="prefetch" href="/assets/js/150.dba60486.js"><link rel="prefetch" href="/assets/js/151.131c2ce3.js"><link rel="prefetch" href="/assets/js/152.f7856915.js"><link rel="prefetch" href="/assets/js/153.85030f41.js"><link rel="prefetch" href="/assets/js/154.d391c30d.js"><link rel="prefetch" href="/assets/js/155.f4ecf27e.js"><link rel="prefetch" href="/assets/js/156.a37b1d50.js"><link rel="prefetch" href="/assets/js/157.16da5132.js"><link rel="prefetch" href="/assets/js/158.74e3b772.js"><link rel="prefetch" href="/assets/js/16.d5510f05.js"><link rel="prefetch" href="/assets/js/17.406fdde6.js"><link rel="prefetch" href="/assets/js/18.d6c076c9.js"><link rel="prefetch" href="/assets/js/19.7fa2e9ac.js"><link rel="prefetch" href="/assets/js/20.34b780a8.js"><link rel="prefetch" href="/assets/js/21.cde8ab77.js"><link rel="prefetch" href="/assets/js/22.796f1c14.js"><link rel="prefetch" href="/assets/js/23.b35df20f.js"><link rel="prefetch" href="/assets/js/24.779ffa04.js"><link rel="prefetch" href="/assets/js/25.16844fc8.js"><link rel="prefetch" href="/assets/js/26.2ebafd18.js"><link rel="prefetch" href="/assets/js/27.12853f03.js"><link rel="prefetch" href="/assets/js/28.bd1799d9.js"><link rel="prefetch" href="/assets/js/29.0675c79e.js"><link rel="prefetch" href="/assets/js/30.152d0668.js"><link rel="prefetch" href="/assets/js/31.bf891295.js"><link rel="prefetch" href="/assets/js/32.74a6cf5d.js"><link rel="prefetch" href="/assets/js/33.636a605e.js"><link rel="prefetch" href="/assets/js/34.61a1356f.js"><link rel="prefetch" href="/assets/js/35.e0cdda34.js"><link rel="prefetch" href="/assets/js/36.ba6be579.js"><link rel="prefetch" href="/assets/js/38.dfba4a42.js"><link rel="prefetch" href="/assets/js/39.5d04b83a.js"><link rel="prefetch" href="/assets/js/4.9ca6cf7c.js"><link rel="prefetch" href="/assets/js/40.de0f03e2.js"><link rel="prefetch" href="/assets/js/41.5ea7a6a0.js"><link rel="prefetch" href="/assets/js/42.d2d91424.js"><link rel="prefetch" href="/assets/js/43.152d6931.js"><link rel="prefetch" href="/assets/js/44.0966555c.js"><link rel="prefetch" href="/assets/js/46.15a94e24.js"><link rel="prefetch" href="/assets/js/47.01ea9b83.js"><link rel="prefetch" href="/assets/js/48.faf5e78b.js"><link rel="prefetch" href="/assets/js/49.7317e541.js"><link rel="prefetch" href="/assets/js/5.bea66500.js"><link rel="prefetch" href="/assets/js/50.1649a842.js"><link rel="prefetch" href="/assets/js/51.01a07b55.js"><link rel="prefetch" href="/assets/js/52.b15b72a5.js"><link rel="prefetch" href="/assets/js/53.e65c7b60.js"><link rel="prefetch" href="/assets/js/54.f6392e9b.js"><link rel="prefetch" href="/assets/js/55.533adec0.js"><link rel="prefetch" href="/assets/js/56.91799a6d.js"><link rel="prefetch" href="/assets/js/57.e6362e7b.js"><link rel="prefetch" href="/assets/js/58.e27f1a3c.js"><link rel="prefetch" href="/assets/js/59.7ffa9758.js"><link rel="prefetch" href="/assets/js/60.e780ff55.js"><link rel="prefetch" href="/assets/js/61.34b7d00b.js"><link rel="prefetch" href="/assets/js/62.b483a660.js"><link rel="prefetch" href="/assets/js/63.da415371.js"><link rel="prefetch" href="/assets/js/64.b990b85d.js"><link rel="prefetch" href="/assets/js/65.e24bfbc7.js"><link rel="prefetch" href="/assets/js/66.18f533e0.js"><link rel="prefetch" href="/assets/js/67.7ec96abe.js"><link rel="prefetch" href="/assets/js/68.639d713a.js"><link rel="prefetch" href="/assets/js/69.a90ec93b.js"><link rel="prefetch" href="/assets/js/7.2b784b0e.js"><link rel="prefetch" href="/assets/js/70.db79271f.js"><link rel="prefetch" href="/assets/js/71.91feb476.js"><link rel="prefetch" href="/assets/js/72.33ab568a.js"><link rel="prefetch" href="/assets/js/73.356c9a6f.js"><link rel="prefetch" href="/assets/js/74.0232291b.js"><link rel="prefetch" href="/assets/js/75.df40f20a.js"><link rel="prefetch" href="/assets/js/76.bebbb912.js"><link rel="prefetch" href="/assets/js/77.d9c2e53b.js"><link rel="prefetch" href="/assets/js/78.d8b6633d.js"><link rel="prefetch" href="/assets/js/79.fcd4b691.js"><link rel="prefetch" href="/assets/js/8.4c5ce23e.js"><link rel="prefetch" href="/assets/js/80.3b03217e.js"><link rel="prefetch" href="/assets/js/81.6fe51e6c.js"><link rel="prefetch" href="/assets/js/82.aa209218.js"><link rel="prefetch" href="/assets/js/83.baa0177d.js"><link rel="prefetch" href="/assets/js/84.0a7a2dcf.js"><link rel="prefetch" href="/assets/js/85.d4f48a73.js"><link rel="prefetch" href="/assets/js/86.a71657d5.js"><link rel="prefetch" href="/assets/js/87.4f61eb3b.js"><link rel="prefetch" href="/assets/js/88.ad473005.js"><link rel="prefetch" href="/assets/js/89.5c8e473e.js"><link rel="prefetch" href="/assets/js/9.1f09c265.js"><link rel="prefetch" href="/assets/js/90.94953419.js"><link rel="prefetch" href="/assets/js/91.2c7df741.js"><link rel="prefetch" href="/assets/js/92.9324381f.js"><link rel="prefetch" href="/assets/js/93.a13d8971.js"><link rel="prefetch" href="/assets/js/94.0ed03065.js"><link rel="prefetch" href="/assets/js/95.340b6689.js"><link rel="prefetch" href="/assets/js/96.1457a554.js"><link rel="prefetch" href="/assets/js/97.ac9281d6.js"><link rel="prefetch" href="/assets/js/98.0afc9c4a.js"><link rel="prefetch" href="/assets/js/99.9f746a95.js">
    <link rel="stylesheet" href="/assets/css/0.styles.acccec19.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/images/logo-color.png" alt="软件架构探索：The Fenix Project" class="logo"> <span class="site-name can-hide">软件架构探索：The Fenix Project</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="代码" class="dropdown-title"><span class="title">代码</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/fenixsoft/awesome-fenix" target="_blank" rel="noopener noreferrer" class="nav-link external">
  文档工程 Awesome-Fenix
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://github.com/fenixsoft/fenix-bookstore-frontend" target="_blank" rel="noopener noreferrer" class="nav-link external">
  前端工程 Fenix's Bookstore
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://bookstore.icyfenix.cn" target="_blank" rel="noopener noreferrer" class="nav-link external">
  前端工程在线示例 Fenix's Bookstore
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://github.com/fenixsoft/monolithic_arch_springboot" target="_blank" rel="noopener noreferrer" class="nav-link external">
  后端：单体架构 Spring Boot
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://github.com/fenixsoft/microservice_arch_springcloud" target="_blank" rel="noopener noreferrer" class="nav-link external">
  后端：微服务架构 Spring Cloud
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://github.com/fenixsoft/microservice_arch_kubernetes" target="_blank" rel="noopener noreferrer" class="nav-link external">
  后端：微服务架构 Kubernetes
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://github.com/fenixsoft/servicemesh_arch_istio" target="_blank" rel="noopener noreferrer" class="nav-link external">
  后端：微服务架构 Istio
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://github.com/fenixsoft/serverless_arch_awslambda" target="_blank" rel="noopener noreferrer" class="nav-link external">
  后端：无服务架构 AWS Lambda
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div><div class="nav-item"><a href="https://raw.githubusercontent.com/fenixsoft/awesome-fenix/gh-pages/pdf/the-fenix-project.pdf" target="_blank" rel="noopener noreferrer" class="nav-link external">
  PDF下载
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="/board/" class="nav-link">
  讨论区
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="代码" class="dropdown-title"><span class="title">代码</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/fenixsoft/awesome-fenix" target="_blank" rel="noopener noreferrer" class="nav-link external">
  文档工程 Awesome-Fenix
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://github.com/fenixsoft/fenix-bookstore-frontend" target="_blank" rel="noopener noreferrer" class="nav-link external">
  前端工程 Fenix's Bookstore
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://bookstore.icyfenix.cn" target="_blank" rel="noopener noreferrer" class="nav-link external">
  前端工程在线示例 Fenix's Bookstore
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://github.com/fenixsoft/monolithic_arch_springboot" target="_blank" rel="noopener noreferrer" class="nav-link external">
  后端：单体架构 Spring Boot
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://github.com/fenixsoft/microservice_arch_springcloud" target="_blank" rel="noopener noreferrer" class="nav-link external">
  后端：微服务架构 Spring Cloud
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://github.com/fenixsoft/microservice_arch_kubernetes" target="_blank" rel="noopener noreferrer" class="nav-link external">
  后端：微服务架构 Kubernetes
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://github.com/fenixsoft/servicemesh_arch_istio" target="_blank" rel="noopener noreferrer" class="nav-link external">
  后端：微服务架构 Istio
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://github.com/fenixsoft/serverless_arch_awslambda" target="_blank" rel="noopener noreferrer" class="nav-link external">
  后端：无服务架构 AWS Lambda
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div><div class="nav-item"><a href="https://raw.githubusercontent.com/fenixsoft/awesome-fenix/gh-pages/pdf/the-fenix-project.pdf" target="_blank" rel="noopener noreferrer" class="nav-link external">
  PDF下载
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="/board/" class="nav-link">
  讨论区
</a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/summary/" class="sidebar-link">目录</a></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>前言</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/introduction/about-me.html" class="sidebar-link">关于作者</a></li><li><a href="/introduction/about-the-fenix-project.html" class="sidebar-link">什么是“The Fenix Project”</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>探索起步</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading open"><span>阅读指引</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/changelog/" class="sidebar-link">更新日志</a></li><li><a href="/exploration/guide/quick-start.html" class="sidebar-link">如何开始</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><a href="/exploration/projects/" class="sidebar-heading clickable"><span>技术演示工程</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/exploration/projects/fenix-bookstore-frontend.html" class="sidebar-link">前端工程</a></li><li><a href="/exploration/projects/monolithic_arch_springboot.html" class="sidebar-link">单体架构：Spring Boot</a></li><li><a href="/exploration/projects/microservice_arch_springcloud.html" class="sidebar-link">微服务：Spring Cloud</a></li><li><a href="/exploration/projects/microservice_arch_kubernetes.html" class="sidebar-link">微服务：Kubernetes</a></li><li><a href="/exploration/projects/servicemesh_arch_istio.html" class="sidebar-link">服务网格：Istio</a></li><li><a href="/exploration/projects/serverless_arch.html" class="sidebar-link">无服务：AWS Lambda</a></li></ul></section></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>演进中的架构</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group is-sub-group depth-1"><a href="/architecture/architect-history/" class="sidebar-heading clickable open"><span>服务架构演进史</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/architecture/architect-history/primitive-distribution.html" class="sidebar-link">原始分布式时代</a></li><li><a href="/architecture/architect-history/monolithic.html" class="sidebar-link">单体系统时代</a></li><li><a href="/architecture/architect-history/soa.html" class="sidebar-link">SOA时代</a></li><li><a href="/architecture/architect-history/microservices.html" class="sidebar-link">微服务时代</a></li><li><a href="/architecture/architect-history/post-microservices.html" class="sidebar-link">后微服务时代</a></li><li><a href="/architecture/architect-history/serverless.html" class="sidebar-link">无服务时代</a></li></ul></section></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>架构师的视角</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group is-sub-group depth-1"><a href="/architect-perspective/general-architecture/api-style/" class="sidebar-heading clickable open"><span>访问远程服务</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/architect-perspective/general-architecture/api-style/rpc.html" class="sidebar-link">远程服务调用</a></li><li><a href="/architect-perspective/general-architecture/api-style/rest.html" class="sidebar-link">REST设计风格</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><a href="/architect-perspective/general-architecture/transaction/" class="sidebar-heading clickable"><span>事务处理</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/architect-perspective/general-architecture/transaction/local.html" class="sidebar-link">本地事务</a></li><li><a href="/architect-perspective/general-architecture/transaction/global.html" class="sidebar-link">全局事务</a></li><li><a href="/architect-perspective/general-architecture/transaction/share.html" class="sidebar-link">共享事务</a></li><li><a href="/architect-perspective/general-architecture/transaction/distributed.html" class="sidebar-link">分布式事务</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><a href="/architect-perspective/general-architecture/diversion-system/" class="sidebar-heading clickable"><span>透明多级分流系统</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/architect-perspective/general-architecture/diversion-system/client-cache.html" class="sidebar-link">客户端缓存</a></li><li><a href="/architect-perspective/general-architecture/diversion-system/dns-lookup.html" class="sidebar-link">域名解析</a></li><li><a href="/architect-perspective/general-architecture/diversion-system/transmission-optimization.html" class="sidebar-link">传输链路</a></li><li><a href="/architect-perspective/general-architecture/diversion-system/cdn.html" class="sidebar-link">内容分发网络</a></li><li><a href="/architect-perspective/general-architecture/diversion-system/load-balancing.html" class="sidebar-link">负载均衡</a></li><li><a href="/architect-perspective/general-architecture/diversion-system/cache-middleware.html" class="sidebar-link">服务端缓存</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><a href="/architect-perspective/general-architecture/system-security/" class="sidebar-heading clickable"><span>架构安全性</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/architect-perspective/general-architecture/system-security/authentication.html" class="sidebar-link">认证</a></li><li><a href="/architect-perspective/general-architecture/system-security/authorization.html" class="sidebar-link">授权</a></li><li><a href="/architect-perspective/general-architecture/system-security/credentials.html" class="sidebar-link">凭证</a></li><li><a href="/architect-perspective/general-architecture/system-security/confidentiality.html" class="sidebar-link">保密</a></li><li><a href="/architect-perspective/general-architecture/system-security/transport-security.html" class="sidebar-link">传输</a></li><li><a href="/architect-perspective/general-architecture/system-security/verification.html" class="sidebar-link">验证</a></li></ul></section></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>分布式的基石</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group is-sub-group depth-1"><a href="/distribution/consensus/" class="sidebar-heading clickable"><span>分布式共识算法</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/distribution/consensus/paxos.html" class="sidebar-link">Paxos</a></li><li><a href="/distribution/consensus/raft.html" class="sidebar-link">Multi Paxos</a></li><li><a href="/distribution/consensus/gossip.html" class="sidebar-link">Gossip协议</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><a href="/distribution/connect/" class="sidebar-heading clickable"><span>从类库到服务</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/distribution/connect/service-discovery.html" class="sidebar-link">服务发现</a></li><li><a href="/distribution/connect/service-routing.html" class="sidebar-link">网关路由</a></li><li><a href="/distribution/connect/load-balancing.html" class="sidebar-link">客户端负载均衡</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><a href="/distribution/traffic-management/" class="sidebar-heading clickable"><span>流量治理</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/distribution/traffic-management/failure.html" class="sidebar-link">服务容错</a></li><li><a href="/distribution/traffic-management/traffic-control.html" class="sidebar-link">流量控制</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><a href="/distribution/secure/" class="sidebar-heading clickable"><span>可靠通讯</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/distribution/secure/zero-trust.html" class="sidebar-link">零信任网络</a></li><li><a href="/distribution/secure/service-security.html" class="sidebar-link">服务安全</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><a href="/distribution/observability/" class="sidebar-heading clickable router-link-active open"><span>可观测性</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/distribution/observability/logging.html" class="sidebar-link">事件日志</a></li><li><a href="/distribution/observability/tracing.html" class="sidebar-link">链路追踪</a></li><li><a href="/distribution/observability/metrics.html" class="active sidebar-link">聚合度量</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/distribution/observability/metrics.html#指标收集" class="sidebar-link">指标收集</a></li><li class="sidebar-sub-header"><a href="/distribution/observability/metrics.html#存储查询" class="sidebar-link">存储查询</a></li><li class="sidebar-sub-header"><a href="/distribution/observability/metrics.html#监控预警" class="sidebar-link">监控预警</a></li></ul></li></ul></section></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>不可变基础设施</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/immutable-infrastructure/msa-to-cn.html" class="sidebar-link">从微服务到云原生</a></li><li><section class="sidebar-group is-sub-group depth-1"><a href="/immutable-infrastructure/container/" class="sidebar-heading clickable"><span>虚拟化容器</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/immutable-infrastructure/container/history.html" class="sidebar-link">容器的崛起</a></li><li><a href="/immutable-infrastructure/container/container-build-system.html" class="sidebar-link">以容器构建系统</a></li><li><a href="/immutable-infrastructure/container/application-centric.html" class="sidebar-link">应用为中心的封装</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><a href="/immutable-infrastructure/network/" class="sidebar-heading clickable"><span>容器间网络</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/immutable-infrastructure/network/linux-vnet.html" class="sidebar-link">Linux网络虚拟化</a></li><li><a href="/immutable-infrastructure/network/cni.html" class="sidebar-link">容器网络与生态</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><a href="/immutable-infrastructure/storage/" class="sidebar-heading clickable"><span>持久化存储</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/immutable-infrastructure/storage/storage-evolution.html" class="sidebar-link">Kubernetes存储设计</a></li><li><a href="/immutable-infrastructure/storage/csi.html" class="sidebar-link">容器存储与生态</a></li></ul></section></li><li><a href="/immutable-infrastructure/schedule/hardware-schedule.html" class="sidebar-link">资源与调度</a></li><li><section class="sidebar-group is-sub-group depth-1"><a href="/immutable-infrastructure/mesh/" class="sidebar-heading clickable"><span>服务网格</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/immutable-infrastructure/mesh/communication.html" class="sidebar-link">透明通信的涅槃</a></li><li><a href="/immutable-infrastructure/mesh/ecosystems.html" class="sidebar-link">服务网格与生态</a></li></ul></section></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>技术方法论</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group is-sub-group depth-1"><a href="/methodology/forward-msa/" class="sidebar-heading clickable open"><span>向微服务迈进</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/methodology/forward-msa/objective.html" class="sidebar-link">目的：微服务的驱动力</a></li><li><a href="/methodology/forward-msa/prerequest.html" class="sidebar-link">前提：微服务需要的条件</a></li><li><a href="/methodology/forward-msa/granularity.html" class="sidebar-link">边界：微服务的粒度</a></li><li><a href="/methodology/forward-msa/governance.html" class="sidebar-link">治理：理解系统复杂性</a></li></ul></section></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>随笔文章</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading open"><span>2020年</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group is-sub-group depth-2"><a href="/tricks/2020/graalvm/" class="sidebar-heading clickable open"><span>Graal VM</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/tricks/2020/graalvm/graal-compiler.html" class="sidebar-link">新一代即时编译器</a></li><li><a href="/tricks/2020/graalvm/substratevm.html" class="sidebar-link">向原生迈进</a></li><li><a href="/tricks/2020/graalvm/graalvm-native.html" class="sidebar-link">没有虚拟机的Java</a></li><li><a href="/tricks/2020/graalvm/spring-over-graal.html" class="sidebar-link">Spring over Graal</a></li></ul></section></li><li><a href="/tricks/2020/java-crisis/qcon.html" class="sidebar-link">QCon2020主题演讲：云原生时代，Java的危与机</a></li></ul></section></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>附录</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group is-sub-group depth-1"><a href="/appendix/deployment-env-setup/" class="sidebar-heading clickable open"><span>部署环境</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/appendix/deployment-env-setup/setup-docker.html" class="sidebar-link">部署Docker CE容器环境</a></li><li><section class="sidebar-group collapsable is-sub-group depth-2"><a href="/appendix/deployment-env-setup/setup-kubernetes/" class="sidebar-heading clickable"><span>部署Kubernetes集群</span> <span class="arrow right"></span></a> <!----></section></li></ul></section></li><li><a href="/appendix/istio.html" class="sidebar-link">部署Istio</a></li><li><a href="/appendix/operation-env-setup/elk-setup.html" class="sidebar-link">部署Elastic Stack</a></li><li><a href="/appendix/operation-env-setup/prometheus-setup.html" class="sidebar-link">部署Prometheus</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="聚合度量">聚合度量</h1> <p>度量（Metrics）的目的是揭示系统的总体运行状态。相信大家应该见过这样的场景：舰船的驾驶舱或者卫星发生中心的控制室，在整个房间最显眼的位置，布满整面墙壁的巨型屏幕里显示着一个个指示器、仪表板与统计图表，沉稳端坐中央的指挥官看着屏幕上闪烁变化的指标，果断决策，下达命令……如果以上场景被改成指挥官双手在键盘上飞舞，双眼紧盯着日志或者追踪系统，试图判断出系统工作是否正常。这光想像一下，都能感觉到一股身份与行为不一致的违和气息。由此可见度量与日志、追踪的差别，度量是用经过聚合统计后的高维度信息，以最简单直观的形式来总结复杂的过程，为监控、预警提供决策支持。</p> <div class="custom-block center"><p><img src="/assets/img/mon.ae554b5a.png" alt=""></p> <p>Windows系统的任务管理器界面</p></div> <p>如果你人生经历比较平淡，没有驾驶航母的经验，甚至连一颗卫星或者导弹都没有发射过，那就只好打开电脑，按<code>CTRL</code>+<code>ALT</code>+<code>DEL</code>呼出任务管理器，看看上面这个熟悉的界面，它也是一个非常具有代表性的度量系统。</p> <p>度量总体上可分为客户端的指标收集、服务端的存储查询以及终端的监控预警三个相对独立的过程，每个过程在系统中一般也会设置对应的组件来实现，你不妨现在先翻到下面，看一眼Prometheus的组件流程图作为例子，图中在Prometheus Server左边的部分都属于客户端过程，右边的部分就属于终端过程。</p> <p><a href="https://prometheus.io/" target="_blank" rel="noopener noreferrer">Prometheus<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>在度量领域的统治力虽然还暂时不如日志领域中Elastic Stack的统治地位那么稳固，但在云原生时代里，基本也已经能算是事实标准了，接下来，笔者将主要以Prometheus为例，介绍这三部分组件的总体思路、大致内容与理论标准。</p> <h2 id="指标收集">指标收集</h2> <p>指标收集部分要解决两个问题：“如何定义指标”以及“如何将这些指标告诉服务端”， 如何定义指标这个问题听起来应该是与目标系统密切相关的，必须根据实际情况才能讨论，其实并不绝对，无论目标是何种系统，都是具备一些共性特征。确定目标系统前我们无法决定要收集什么指标，但指标的数据类型（Metrics Types）是可数的，所有通用的度量系统都是面向指标的数据类型来设计的：</p> <ul><li><strong>计数度量器</strong>（Counter）：这是最好理解也是最常用的指标形式，计数器就是对有相同量纲、可加减数值的合计量，譬如业务指标像销售额、货物库存量、职工人数等等；技术指标像服务调用次数、网站访问人数等都属于计数器指标。</li> <li><strong>瞬态度量器</strong>（Gauge）：瞬态度量器比计数器更简单，它就表示某个指标在某个时点的数值，连加减统计都不需要。譬如当前Java虚拟机堆内存的使用量，这就是一个瞬态度量器；又譬如，网站访问人数是计数器，而网站在线人数则是瞬态度量器。</li> <li><strong>吞吐率度量器</strong>（Meter）：吞吐率度量器顾名思义是用于统计单位时间的吞吐量，即单位时间内某个事件的发生次数。譬如交易系统中常以TPS衡量事务吞吐率，即每秒发生了多少笔事务交易；又譬如港口的货运吞吐率常以“吨/每天”为单位计算，10万吨/天的港口通常要比1万吨/天的港口的货运规模更大。</li> <li><strong>直方图度量器</strong>（Histogram）：直方图在是常见二维统计图，它的两个坐标分别是统计样本和该样本对应的某个属性的度量，以长条图的形式具体数值。譬如经济报告中要衡量某个地区历年的GDP变化情况，常会以GDP为纵坐标，时间为横坐标构成直方图来呈现。</li> <li><strong>采样点分位图度量器</strong>（Quantile Summary）：分位图是统计学中通过比较各分位数的分布情况的工具，用于验证实际值与理论值的差距，评估理论值与实际值之间的拟合度。譬如，我们说“高考成绩一般符合正态分布”，这句话的意思是：高考成绩高低分的人数都较少，中等成绩的较多，将人数按不同分数段统计，得出的统计结果一般能够与正态分布的曲线较好地拟合。</li> <li>除了以上常见的度量器之外，还有Timer、Set、Fast Compass、Cluster Histogram等其他各种度量器，采用不同的度量系统，支持度量器类型的范围肯定会有差别，譬如Prometheus支持了上面提到五种度量器中的Counter、Gauge、Histogram和Summary四种。</li></ul> <p>对于“如何将这些指标告诉服务端”这个问题，通常有两种解决方案：<strong>拉取式采集</strong>（Pull-Based Metrics Collection）和<strong>推送式采集</strong>（Push-Based Metrics Collection）。所谓Pull是指度量系统主动从目标系统中拉取指标，相对地，Push就是由目标系统主动向度量系统推送指标。这两种方式并没有绝对的好坏优劣，以前很多老牌的度量系统，如<a href="https://en.wikipedia.org/wiki/Ganglia_(software)" target="_blank" rel="noopener noreferrer">Ganglia<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>、<a href="https://graphiteapp.org/" target="_blank" rel="noopener noreferrer">Graphite<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>、<a href="https://github.com/statsd/statsd" target="_blank" rel="noopener noreferrer">StatsD<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>等是基于Push的，而以Prometheus、<a href="https://www.datadoghq.com/pricing/" target="_blank" rel="noopener noreferrer">Datadog<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>、<a href="https://en.wikipedia.org/wiki/Collectd" target="_blank" rel="noopener noreferrer">Collectd<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>为代表的另一派度量系统则青睐Pull式采集（Prometheus官方解释<a href="https://prometheus.io/docs/introduction/faq/#why-do-you-pull-rather-than-push?" target="_blank" rel="noopener noreferrer">选择Pull的原因<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>）。Push还是Pull的权衡，不仅仅在度量中才有，所有涉及到客户端和服务端通讯的场景，都会涉及到该谁主动的问题，上一节中讲的追踪系统也是如此。</p> <div class="custom-block center"><p><img src="/assets/img/prometheus_architecture.8b9f3856.png" alt="">
Prometheus组件流程图（图片来自<a href="https://github.com/prometheus/prometheus" target="_blank" rel="noopener noreferrer">Prometheus官网<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>）</p></div> <p>一般来说，度量系统只会支持其中一种指标采集方式，因为度量系统的网络连接数量，以及对应的线程或者协程数可能非常庞大，如何采集指标将直接影响到整个度量系统的架构设计。Prometheus基于Pull架构的同时还能够有限度地兼容Push式采集，是因为它有Push Gateway的存在，如上图所示，这是一个位于Prometheus Server外部的相对独立的中介模块，将外部推送来的指标放到Push Gateway中暂存，然后再等候Prometheus Server从Push Gateway中去拉取。Prometheus设计Push Gateway的本意是为了解决Pull的一些固有缺陷，譬如目标系统位于内网，通过NAT访问外网，外网的Prometheus是无法主动连接目标系统的，这就只能由目标系统主动推送数据；又譬如某些小型短生命周期服务，可能还等不及Prometheus来拉取，服务就已经结束运行了，因此也只能由服务自己Push来保证度量的及时和准确。</p> <p>由推和拉决定该谁主动以后，另一个问题是指标应该以怎样的网络访问协议、取数接口、数据结构来获取？如同计算机科学中其他这类的问题类似，一贯的解决方向是“定义规范”，应该由行业组织和主流厂商一起协商出专门用于度量的协议，目标系统按照协议与度量系统交互。譬如，网络管理中的<a href="https://en.wikipedia.org/wiki/Simple_Network_Management_Protocol" target="_blank" rel="noopener noreferrer">SNMP<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>、Windows硬件的<a href="https://en.wikipedia.org/wiki/Windows_Management_Instrumentation" target="_blank" rel="noopener noreferrer">WMI<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>、以及此前提到的Java的<a href="https://en.wikipedia.org/wiki/Java_Management_Extensions" target="_blank" rel="noopener noreferrer">JMX<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>都属于这种思路的产物。但是，定义标准这个办法在度量领域中就不是那么有效，上述列举的度量协议，只在特定的一块小块领域上流行过。原因一方面是业务系统要使用这些协议并不容易，你可以想像一下，让订单金额存到SNMP中，让Golang的系统把指标放到JMX Bean里，即便技术上可行，这也不像是正常程序员会干的事；另一方面，度量系统又不会甘心局限于某个领域，成为某项业务的附属品。度量面向的是广义上的信息系统，横跨存储（日志、文件、数据库）、通讯（消息、网络）、中间件（HTTP服务、API服务），直到系统本身的业务指标，甚至还会包括度量系统本身（部署两个独立的Prometheus互相监控是很常见的）。所以，上面这些度量协议其实都没有成为最正确答案的希望。</p> <p>既然没有了标准，有一些度量系统，譬如老牌的Zabbix就选择同时支持了SNMP、JMX、IPMI等多种不同的度量协议，另一些度量系统，以Prometheus为代表就相对强硬，选择任何一种协议都不去支持，只允许通过HTTP访问度量端点这一种访问方式。如果目标提供了HTTP的度量端点（如Kubernetes、Etcd等本身就带有Prometheus的Client Library）就直接访问，否则就需要一个专门的Exporter来充当媒介。</p> <p>Exporter是Prometheus提出的概念，它是目标应用的代表，既可以独立运行，也可以与应用运行在同一个进程中，只要集成Prometheus的Client Library便可。Exporter以HTTP协议（Prometheus在2.0版本之前支持过Protocol Buffer，目前已不再支持）返回符合Prometheus格式要求的文本数据给Prometheus服务器。</p> <p>得益于Prometheus的良好社区生态，现在已经有大量各种用途的Exporter，让Prometheus的监控范围几乎能涵盖所有用户所关心的目标，如下表所示。绝大多数用户都只需要针对自己系统业务方面的度量指标编写Exporter即可。</p> <table><thead><tr><th>范围</th> <th>常用Exporter</th></tr></thead> <tbody><tr><td>数据库</td> <td>MySQL Exporter、Redis Exporter、MongoDB Exporter、MSSQL Exporter等</td></tr> <tr><td>硬件</td> <td>Apcupsd Exporter，IoT Edison Exporter， IPMI Exporter、Node Exporter等</td></tr> <tr><td>消息队列</td> <td>Beanstalkd Exporter、Kafka Exporter、NSQ Exporter、RabbitMQ Exporter等</td></tr> <tr><td>存储</td> <td>Ceph Exporter、Gluster Exporter、HDFS Exporter、ScaleIO Exporter等</td></tr> <tr><td>HTTP服务</td> <td>Apache Exporter、HAProxy Exporter、Nginx Exporter等</td></tr> <tr><td>API服务</td> <td>AWS ECS Exporter， Docker Cloud Exporter、Docker Hub Exporter、GitHub Exporter等</td></tr> <tr><td>日志</td> <td>Fluentd Exporter、Grok Exporter等</td></tr> <tr><td>监控系统</td> <td>Collectd Exporter、Graphite Exporter、InfluxDB Exporter、Nagios Exporter、SNMP Exporter等</td></tr> <tr><td>其它</td> <td>Blockbox Exporter、JIRA Exporter、Jenkins Exporter， Confluence Exporter等</td></tr></tbody></table> <p>顺便一提，前文提到了一堆没有希望成为最终答案的协议，一种名为<a href="https://github.com/OpenObservability/OpenMetrics" target="_blank" rel="noopener noreferrer">OpenMetrics<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>的度量规范正在从Prometheus的数据格式中逐渐分离出来，有望成为监控数据格式的国际标准，最终结果如何，要看Prometheus本身的发展情况，还有OpenTelemetry与OpenMetrics的关系如何协调。</p> <h2 id="存储查询">存储查询</h2> <p>指标从目标系统采集过来之后，应存储在度量系统中，以便被后续的分析界面、监控预警所使用。存储数据对于计算机软件来说是司空见惯的操作，但如果用传统关系数据库的思路来解决度量系统的存储，效果可能不会太理想。举个例子，假设你建设一个中等规模的、有着200个节点的微服务系统，每个节点要采集的存储、网络、中间件和业务等各种指标加一起，也按200个来计算，监控的频率如果按秒为单位的话，一天时间内就会产生超过34亿条记录，这很大概率会出乎你的意料之外：</p> <div class="custom-block center"><blockquote><p>200（节点）× 200（指标）× 86400（秒）= 3,456,000,000（记录）</p></blockquote></div> <p>大多数这种200节点规模的系统，本身一天的业务发生数据都远到不了34亿条，建设度量系统，肯定不能让度量反倒成了业务系统的负担，可见，度量的存储是需要专门研究解决的问题。至于如何解决，让我们先来观察一段Prometheus的真实度量数据，如下所示：</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
	<span class="token comment">// 时间戳</span>
	<span class="token property">&quot;timestamp&quot;</span><span class="token operator">:</span> <span class="token number">1599117392</span><span class="token punctuation">,</span>
	<span class="token comment">// 指标名称</span>
	<span class="token property">&quot;metric&quot;</span><span class="token operator">:</span> <span class="token string">&quot;total_website_visitors&quot;</span><span class="token punctuation">,</span>
	<span class="token comment">// 标签组</span>
	<span class="token property">&quot;tags&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
		<span class="token property">&quot;host&quot;</span><span class="token operator">:</span> <span class="token string">&quot;icyfenix.cn&quot;</span><span class="token punctuation">,</span>
		<span class="token property">&quot;job&quot;</span><span class="token operator">:</span> <span class="token string">&quot;prometheus&quot;</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token comment">// 指标值</span>
	<span class="token property">&quot;value&quot;</span><span class="token operator">:</span> <span class="token number">10086</span>
<span class="token punctuation">}</span>
</code></pre></div><p>观察这段度量数据的特征：每一个度量指标由时间戳、名称、值和一组标签构成，除了时间之外，指标不与任何其他因素相关。指标的数据总量固然是不小的，但它没有嵌套、没有关联、没有主外键，不必关心范式和事务，这些都是可以针对性优化的地方。事实上，业界早就已经存在了专门针对该类型数据的数据库了，即“时序数据库”（Time Series Database）。</p> <div class="quote"><p class="title">额外知识：时序数据库</p><p>时序数据库用于存储跟随时间而变化的数据，并且以时间（时间点或者时间区间）来建立索引的数据库。</p> <p>时序数据库最早是应用于工业（电力行业、化工行业）应用的各类型实时监测、检查与分析设备所采集、产生的数据，这些工业数据的典型特点是产生频率快（每一个监测点一秒钟内可产生多条数据）、严重依赖于采集时间（每一条数据均要求对应唯一的时间）、测点多信息量大（常规的实时监测系统均可达到成千上万的监测点，监测点每秒钟都在产生数据）。</p> <p>时间序列数据是历史烙印，具有不变性,、唯一性、有序性。时序数据库同时具有数据结构简单，数据量大的特点。</p></div><p>写操作，时序数据通常只是追加，很少删改或者根本不允许删改。针对数据热点只集中在近期数据、多写少读、几乎不删改、数据只顺序追加这些特点，时序数据库被允许做出很激进的存储、访问和保留策略（Retention Policies）：</p> <ul><li>以<a href="https://en.wikipedia.org/wiki/Log-structured_merge-tree" target="_blank" rel="noopener noreferrer">日志结构的合并树<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>（Log Structured Merge Tree，LSM-Tree）代替传统关系型数据库中的<a href="https://en.wikipedia.org/wiki/B%2B_tree" target="_blank" rel="noopener noreferrer">B+Tree<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>作为存储结构，LSM适合的应用场景就是写多读少，且几乎不删改的数据。</li> <li>设置激进的数据保留策略，譬如根据过期时间（TTL）自动删除相关数据以节省存储空间，同时提高查询性能。对于普通数据库来说，数据会存储一段时间后被自动删除是不可想象的。</li> <li>对数据进行再采样（Resampling）以节省空间，譬如最近几天的数据可能需要精确到秒，而查询一个月前的时，只需要精确到天，查询一年前的数据，只要精确到周就够了，这样将数据重新采样汇总就可以极大节省了存储空间。</li></ul> <p>时序数据库中甚至还有一种并不罕见却更加极端的形式，叫做<a href="https://en.wikipedia.org/wiki/RRDtool" target="_blank" rel="noopener noreferrer">轮替型数据库<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>（Round Robin Database，RRD），以环形缓冲（在“<a href="/architect-perspective/general-architecture/diversion-system/cache-middleware.html">服务端缓存</a>”一节介绍过）的思路实现，只能存储固定数量的最新数据，超期或超过容量的数据就会被轮替覆盖，因此也有着固定的数据库容量，却能接受无限量的数据输入。</p> <p>Prometheus服务端自己就内置了一个强大时序数据库实现，“强大”并非客气，近几年它在<a href="https://db-engines.com/en/ranking/time+series+dbms" target="_blank" rel="noopener noreferrer">DB-Engines<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>的排名中不断提升，目前已经跃居时序数据库排行榜的前三。该时序数据库提供了名为PromQL的数据查询语言，能对时序数据进行丰富的查询、聚合以及逻辑运算。某些时序库（如排名第一的<a href="https://en.wikipedia.org/wiki/InfluxDB" target="_blank" rel="noopener noreferrer">InfluxDB<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>）也会提供类SQL风格查询，但PromQL不是，它是一套完全由Prometheus自己定制的数据查询<a href="https://en.wikipedia.org/wiki/Domain-specific_language" target="_blank" rel="noopener noreferrer">DSL<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，写起来风格有点像带运算与函数支持的CSS选择器。譬如要查找网站<code>icyfenix.cn</code>访问人数，会是如下写法：</p> <div class="language- extra-class"><pre class="language-text"><code>// 查询命令：
total_website_visitors{host=“icyfenix.cn”}

// 返回结果：
total_website_visitors{host=“icyfenix.cn”,job=&quot;prometheus&quot;}=(10086)
</code></pre></div><p>通过PromQL可以轻易实现指标之间的运算、聚合、统计等操作，在查询界面中往往需要通过PromQL计算多种指标的统计结果才能满足监控的需要，语法方面的细节笔者就不详细展开了，具体可以参考<a href="https://prometheus.io/docs/prometheus/latest/querying/basics/" target="_blank" rel="noopener noreferrer">Prometheus的文档手册<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p> <p>最后补充说明一下，时序数据库对度量系统来说是很合适的选择，但并不是说绝对只有用时序数据库才能解决度量指标的存储问题，Prometheus流行之前最老牌的度量系统Zabbix用的就是传统关系数据库来存储指标。</p> <h2 id="监控预警">监控预警</h2> <p>指标度量是手段，最终目的是做分析和预警。界面分析和监控预警是与用户更加贴近的功能模块，但对度量系统本身而言，它们都属于相对外围的功能。与追踪系统的情况类似，广义上的度量系统由面向目标系统进行指标采集的客户端（Client，与目标系统进程在一起的Agent，或者代表目标系统的Exporter等都可归为客户端），负责调度、存储和提供查询能力的服务端（Server，Prometheus的服务端是带存储的，但也有很多度量服务端需要配和独立的存储来使用的），以及面向最终用户的终端（Backend，UI界面、监控预警功能等都归为终端）组成。狭义上的度量系统就只包括客户端和服务端，不包含终端。</p> <p>按照定义，Prometheus应算是处于狭义和广义的度量系统之间，尽管它确实内置了一个界面解决方案“Console Template”，以模版和JavaScript接口的形式提供了一系列预设的组件（菜单、图表等），让用户编写一段简单的脚本就可以实现可用的监控功能。不过这种可用程度，往往不足以支撑正规的生产部署，只能说是为把度量功能嵌入到系统的某个子系统中提供了一定便利。在生产环境下，大多是Prometheus配合Grafana来进行展示的，这是Prometheus官方推荐的组合方案，但该组合也并非唯一选择，如果要搭配Klbana甚至SkyWalking（8.x版之后的SkyWalking支持从Prometheus获取度量数据）来使用也都是完全可行的。</p> <p>良好的可视化能力对于提升度量系统的产品力十分重要，长期趋势分析（譬如根据对磁盘增长趋势的观察判断什么时候需要扩容）、对照分析（譬如版本升级后对比新旧版本的性能、资源消耗等方面的差异）、故障分析（不仅从日志、追踪自底向上可以分析故障，高维度的度量指标也可能自顶向下寻找到问题的端倪）等分析工作，既需要度量指标的持续收集、统计，往往还需要对数据进行可视化，才能让人更容易地从数据中挖掘规律，毕竟数据最终还是要为人类服务的。</p> <p>除了为分析、决策、故障定位等提供支持的用户界面外，度量信息的另一种主要的消费途径是用来做预警。譬如你希望当磁盘消耗超过90%时给你发送一封邮件或者是一条微信消息，通知管理员过来处理，这就是一种预警。Prometheus提供了专门用于预警的Alert Manager，将Alert Manager与Prometheus关联后，可以设置某个指标在多长时间内达到何种条件就会触发预警状态，触发预警后，根据路由中配置的接收器，譬如邮件接收器、Slack接收器、微信接收器、或者更通用的<a href="https://en.wikipedia.org/wiki/Webhook" target="_blank" rel="noopener noreferrer">WebHook<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>接收器等来自动通知用户。</p></div> <footer class="page-edit"><!----> <div class="git-hub-star"><span class="prefix">
      Kudos to
      <span style="position:relative;top:4px;right:-4px;"><a href="https://github.com/fenixsoft/awesome-fenix" aria-label="Star fenixsoft/awesome-fenix on GitHub" data-icon="octicon-star" data-show-count="true">
      Star
    </a></span></span></div> <div class="last-updated"><span class="prefix">总字数:</span> <span class="words">5,719</span> <span class="prefix">字　</span> <span class="prefix">最后更新:</span> <span class="time">11/16/2020, 5:37:13 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
    ←
    <a href="/distribution/observability/tracing.html" class="prev">
      链路追踪
    </a></span> <span class="next"><a href="/immutable-infrastructure/msa-to-cn.html">
      从微服务到云原生
    </a>
    →
  </span></p></div> </main></div><div class="global-ui"><div></div><!----></div></div>
    <script src="/assets/js/app.0156b363.js" defer></script><script src="/assets/js/3.0a6c0dd5.js" defer></script><script src="/assets/js/6.b08f2b32.js" defer></script><script src="/assets/js/37.6a2be385.js" defer></script><script src="/assets/js/45.23f3e077.js" defer></script>
  </body>
</html>
